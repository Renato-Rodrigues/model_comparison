---
title: "ECEMF model comparison plots"
output:
  html_document:
    theme: paper
    toc: true
    toc_float: 
      collapsed: false
    toc_depth: 1
params:
    updateResults: FALSE
    regionDisplayed: "EU27"
    scenarios: NULL
    type: FALSE
    forceSave: FALSE
---

<!-- author: "Renato Rodrigues" -->

<style>
  .main-container {
    max-width: 95% !important;
  }
  .toc-content {
    padding-left: 0px !important;
  }
  .svg-container {
    margin: auto !important;
  }
  /* MODAL */
  /* The Modal (background) */
  .modal {
    position: fixed; /* Stay in place */
    z-index: 400; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  }
  
  /* Modal Content/Box */
  .modal-content {
    position: fixed;
    left: 50%;
    top: 50%;
    background-color: #fefefe;
    border: 1px solid #888;
    margin: auto;
    max-width: 96vw;
    max-height: 96vh;
    transform: translate(-50%,-50%);
  }
  
  /* The Close Button */
  .close {
    position: fixed;
    right: 0;
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    margin-right: 10px;
  }
  
  .close:hover,
  .close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
  }

  .modal-img {
    max-width: 96vw;
      max-height: 96vh;
  }
  
  .hide {
    display:none;
  }
  
  .block{
    display:block;
  }

</style>


Description:
Model comparison for ECEMF - Summary plots.

<!-- Options -->
```{r Options, echo=FALSE, include=FALSE}
# if you want to download new results set updateResults to TRUE, else the script will load the latest created csv file in the folder ./data
updateResults <- FALSE
updateResults <- params$updateResults

regionDisplayed <- "EU27"
regionDisplayed <- params$regionDisplayed

type <- FALSE
type <- params$type

selectedScenarios  <- c("DIAG-NPI", "DIAG-Base", "DIAG-C400-lin", "DIAG-NZero")
selectedScenarios  <- params$scenarios

forceSave <- FALSE
forceSave <- params$forceSave

#chunk size and aspect ratio
chunk <- list(
  nrow1 = list(
    width = 16,
    height = 8
  ),
  nrow2 = list(
    width = 16,
    height = 8
  ),
  nrow3 = list(
    width = 16,
    height = 11.5
  )
)

```


<!-- Loading required packages -->
```{r Loading_required_packages, echo=FALSE, include=FALSE}
library(reticulate)
library(jsonlite)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
library(grid)
library(svglite)
library(gtable)
library(ggplotify)
library(ggpattern)
library(quitte)
```


Regions represented in the plots:

```{r, echo=FALSE}

  if(regionDisplayed=="EU27"){
    regionsText <- paste0('
* EU27: "REMIND 2.1", "WITCH 5.1", "OSeMBE v1.0.0" (calculated) and "Euro-Calliope 2.0"
* EU27 & UK: "MEESA v1.1"
* Europe: "IMAGE 3.2", "PROMETHEUS 1.2"   
* Europe (excl. Turkey): "TIAM-ECN 1.2"
* Europe (incl. Turkey): "MESSAGEix-GLOBIOM 1.2"
* “PRIMES” is missing results in the database`\n\n
')
  } else if(regionDisplayed=="EU27 & UK"){
    regionsText <- paste0('
* EU27 & UK: "REMIND 2.1", "WITCH 5.1", "MEESA v1.1", "OSeMBE v1.0.0" (calculated) and "Euro-Calliope 2.0"
* Europe: "IMAGE 3.2", "PROMETHEUS 1.2"   
* Europe (excl. Turkey): "TIAM-ECN 1.2"
* Europe (incl. Turkey): "MESSAGEix-GLOBIOM 1.2"
* “PRIMES” is missing results in the database`\n\n
')
  }

```

`r paste(knitr::knit(text = regionsText))`


```{r download_data, include=FALSE}
if(updateResults){
  if (file.exists("credentials.json")){
    credentials <- fromJSON("credentials.json")
  } else {
    stop('To download the most up to date ECEMF data, please rename the file "credentials_example.json" to "credentials.json" and fill it with your iiasa database credentials.')
  }
}

#create data folder
if(!(file.exists("./data")))
   dir.create("./data")

```


```{python, include=FALSE}

if (r.updateResults):

  import pyam
  pyam.iiasa.set_config(r.credentials["login"], r.credentials["password"])
  conn = pyam.iiasa.Connection()
  conn.connect('ecemf_internal')

  df = conn.query(
      model='*',
      variable='*',
      region='*'
  )

  from datetime import datetime
  now = datetime.now()
  filename = "data_" + now.strftime("%Y_%m_%d_%H.%M.%S")

  df.to_excel("./data/" + filename + ".xlsx")

  import pandas as pd

  read_file = pd.read_excel("./data/" + filename + ".xlsx", sheet_name="data")
  read_file.to_csv("./data/" + filename + ".csv", index = None, header=True)

```


```{r load_data, include=FALSE}

  files <- file.info(list.files(path="./data", pattern="^data_.*.csv", full.names = T))

  if (!(nrow(files))){
    stop('You need a valid csv file in the ./data folder with model data. You can set the option updateResults to TRUE to download the data directly from the iiasa database. Just set your credentials to the database also in the "credentials.json" file.')
  }
  filename <- rownames(files)[which.max(files$mtime)]

  dateString <- gsub("./data/data_|.csv", "", filename)

  df <- read.csv(filename,check.names=FALSE,stringsAsFactors=FALSE, dec = ".")

  # removing unwanted scenarios
  scenNames <- c("DIAG-Base","DIAG-NPI","DIAG-C80-gr5","DIAG-C0to80-gr5","DIAG-C400-lin","DIAG-NZero","DIAG-C400-lin-LimBio","DIAG-C400-lin-LimCCS","DIAG-C400-lin-LimNuclear","DIAG-C400-lin-HighVRE","DIAG-C400-lin-HighElectrification","DIAG-C400-lin-HighH2","DIAG-C400-lin-ResidualFossil","DIAG-C400-lin-HighEff")
  df <- df[(df$Scenario %in% scenNames),] 
  
  #long format
  dfLong <- df %>%
    gather(Period, Value, -c(1:5))

  # load hist data
  histDf <- read.csv("./hist/hist.csv",check.names=FALSE,stringsAsFactors=FALSE, dec = ".")

  histDf <- histDf[histDf$Region == regionDisplayed,]
  histDf <- histDf[! names(histDf) %in% c("")] # remove columns with no names
  
  histData <- histDf %>%
    gather(Period, Value, -c(1:5))
  histData$Value <- as.numeric(as.character(histData$Value))
  
  # #copy 2019 CEDS to 2020 values
  # tmp <- histData[histData$Scenario == "CEDS" & histData$Period==2019,]
  # tmp$Period <- 2020
  # tmp$Scenario <- "2019 CEDS"
  # histData <- rbind(histData, tmp)
  
  #copy 2018 Eurostat to 2020 values
  if(regionDisplayed=="EU27"){
    eurostatLabel <- "2019 Eurostat"
    tmp <- histData[histData$Scenario == "Eurostat" & histData$Period==2019,]
    tmp$Period <- 2020
    tmp$Scenario <- "2019 Eurostat"
    histData <- rbind(histData, tmp)
  } else if(regionDisplayed=="EU27 & UK"){
    eurostatLabel <- "2018 Eurostat"
    tmp <- histData[histData$Scenario == "Eurostat" & histData$Period==2018,]
    tmp$Period <- 2020
    tmp$Scenario <- "2018 Eurostat"
    histData <- rbind(histData, tmp)
  }  
  # #copy 2019 UNFCCC to 2020 values
  # tmp <- histData[histData$Scenario == "UNFCCC" & histData$Period==2019,]
  # tmp$Period <- 2020
  # tmp$Scenario <- "2019 UNFCCC"
  # histData <- rbind(histData, tmp)
  
  # #remove CEDS CO2 emi, due to other sources being better
  # varsToRemove <- unique(histData[histData$Scenario=="CEDS",]$Variable)[grepl("Emissions\\|CO2",unique(histData[histData$Scenario=="CEDS",]$Variable,fixed=TRUE))]
  # histData <- histData[!(histData$Scenario == "CEDS" & histData$Variable %in% varsToRemove),]
  # varsToRemove <- unique(histData[histData$Scenario=="2019 CEDS",]$Variable)[grepl("Emissions\\|CO2",unique(histData[histData$Scenario=="2019 CEDS",]$Variable,fixed=TRUE))]
  # histData <- histData[!(histData$Scenario == "2019 CEDS" & histData$Variable %in% varsToRemove),]
  
  # filter
  histData <- histData[histData$Scenario %in% c("EU_ReferenceScenario_2020","James_IMF","Eurostat",eurostatLabel),] #,"2019 UNFCCC","UNFCCC", "CEDS","2019 CEDS"

  #shortNames
  histData[histData$Scenario == "EU_ReferenceScenario_2020",]$Scenario <- "EU27Ref"
  histData[histData$Scenario == "James_IMF",]$Scenario <- "IMF"

  if(regionDisplayed=="EU27 & UK"){ #remove EU27Ref from EU28 plots
    histData <- histData[histData$Scenario != "EU27Ref",]
  }
  
  #histData[histData$Scenario == "CEDS" & histData$Variable == "Emissions|N2O",]$Value <- histData[histData$Scenario == "CEDS" & histData$Variable == "Emissions|N2O",]$Value * 1000
  #histData <- histData[!(histData$Scenario == "CEDS" & histData$Variable == "Emissions|N2O"),]

  # add space in front to force position in stacked bar
  histData$Scenario <- paste0(" ", histData$Scenario)
  
  #merge data with hist
  df <- rbind(dfLong,histData)

  # removing Na Values
  df <- df[!is.na(df$Value),]


```


Results created using data downloaded at: `r dateString`


<!-- Loading Data -->
```{r preparing_data, echo=FALSE, include=FALSE}

#check for duplicated rows
dupl <- duplicated(df)
if(any(dupl)){
  print("duplicated rows")
  print(unique(df[dupl,c(1,2)]))
}

#remove unwanted models
df <- df[!df$Model %in% c("WITCH 5.0"),]
#df <- df[!df$Model %in% c("Reference"),]
#df <- df[!df$Model %in% c("OSeMBE v0.1.2", "test_model","MESSAGEix-GLOBIOM_1.2","WITCH 5.0"),]

#modelxscenario
#unique(df[,c(1,2)])



# # removing duplicated scenarios
# df <- df[!((df$Model == "Euro-Calliope 2.0") & (df$Scenario %in% c("DIAG-C400-LimBio", "DIAG-C400-LimCCS","DIAG-C400-LimNuc"))),]
# df <- df[!((df$Model == "PROMETHEUS 1.2") & (df$Scenario %in% c("DIAG-C80-gr5 "))),]
# df <- df[!((df$Model == "TIAM-ECN 1.2") & (df$Scenario %in% c("DIAG_C0to80-gr5","DIAG_C400-lin","DIAG_C80-gr5","DIAG_NPi","DIAG_NZero","DIAG_Npi","DIAG_Nzero"))),]
# df <- df[!((df$Model == "WITCH 5.1") & (df$Scenario %in% c("DIAG-NPI0"))),]
# 
# 
# #accepted scenarios
# scenNames <- c("DIAG-Base","DIAG-NPI","DIAG-C80-gr5","DIAG-C0to80-gr5","DIAG-C400-lin","DIAG-NZero","DIAG-C400-lin-LimBio","DIAG-C400-lin-LimCCS","DIAG-C400-lin-LimNuclear","DIAG-C400-lin-HighVRE","DIAG-C400-lin-HighElectrification","DIAG-C400-lin-HighH2","DIAG-C400-lin-ResidualFossil","DIAG-C400-lin-HighEff")
# extraScen <- unique(df$Scenario)[!(unique(df$Scenario) %in% c(scenNames,unique(histData$Scenario)))]
# if(length(extraScen != 0)){
#   #rename scenarios
#   print(paste0("Wrong named scenarios found: ", extraScen))
#   scenRename <- c(
#     "DIAG-Nzero"="DIAG-NZero",
#     "DIAG-Npi"="DIAG-NPI"
#   )
#   df[df$Scenario %in% names(scenRename),]$Scenario <- scenRename[df[df$Scenario %in% names(scenRename),]$Scenario]
# }

# scenRename <- c(
#   "DIAG-C400-LimBio" = "DIAG-C400-lin-LimBio",
#   "DIAG-C400-LimBio " = "DIAG-C400-lin-LimBio",
#   "DIAG-C400-LimBio " = "DIAG-C400-lin-LimBio",
#   "DIAG-C400-LimBioÂ " = "DIAG-C400-lin-LimBio",
#   "DIAG-C400-limCCS" = "DIAG-C400-lin-LimCCS",
#   "DIAG-C400-lin-LimCCS" = "DIAG-C400-lin-LimCCS",
#   "DIAG-C400-LimCCS" = "DIAG-C400-lin-LimCCS",
#   "DIAG-C400-limNuclear" = "DIAG-C400-lin-LimNuclear",
#   "DIAG-C400-LimNuc" = "DIAG-C400-lin-LimNuclear",
#   "DIAG-C400-LimNuclear" = "DIAG-C400-lin-LimNuclear",
#   "DIAG-C400-lin-HighVRE"="DIAG-C400-lin-HighVRE",
#   "DIAG-C400-lin-HighVRE"="DIAG-C400-lin-HighVRE",
#   "DIAG-C400-lin-HighElectrification "="DIAG-C400-lin-HighElectrification",
#   "DIAG-C400-lin-HighElectrification"= "DIAG-C400-lin-HighElectrification",
#   "DIAG-C400-lin-HighElectrification"= "DIAG-C400-lin-HighElectrification",
#   "DIAG-C400-lin-HighH2"= "DIAG-C400-lin-HighH2",
#   "DIAG-C400-lin-ResidualFossil"= "DIAG-C400-lin-ResidualFossil",
#   "DIAG-C400-lin-HighEff"= "DIAG-C400-lin-HighEff",
#   "DIAG-C400-lin-HighVRE "="DIAG-C400-lin-HighVRE"
# )
#df[df$Scenario %in% names(scenRename),]$Scenario <- scenRename[df[df$Scenario %in% names(scenRename),]$Scenario]

#rescale results for N2O in WITCH
#df[df$Model == "WITCH 5.1" & df$Variable == "Emissions|N2O",]$Value <- df[df$Model == "WITCH 5.1" & df$Variable == "Emissions|N2O",]$Value/1000

# PROMETHEUS 1.2 is providing values at millions
#df[df$Unit == "million EUR/yr",]$Value <- df[df$Unit == "million EUR/yr",]$Value / 1000
#df[df$Unit == "million EUR/yr",]$Unit <- "billion EUR/yr"

# remove negative carbon prices (TIAM-ECN case)
df <- df[!(df$Variable == "Price|Carbon" & df$Value < 0),]

# select scenarios
histScen <- unique(df[df$Model == "reference",]$Scenario)
if (is.null(selectedScenarios)){
  policyScen <- c("DIAG-NPI", "DIAG-Base", "DIAG-C80-gr5", "DIAG-C0to80-gr5", "DIAG-C400-lin", "DIAG-NZero")
} else {
  policyScen <- selectedScenarios
}
df <- df[(df$Scenario %in% c(histScen,policyScen)),]

#Calculate extra variables

for (model in unique(df$Model)){
  if (nrow(df[df$Variable %in% c("Secondary Energy|Electricity|Wind") & df$Model == model,]) == 0){
    tmp <- NULL
    tmp <- df[df$Variable %in% c("Secondary Energy|Electricity|Wind|Offshore", "Secondary Energy|Electricity|Wind|Onshore"),] %>%
          group_by(Model,Scenario,Region,Unit,Period) %>%
          summarize(Value = sum(Value, na.rm = TRUE),.groups="drop")
    tmp$Variable <- "Secondary Energy|Electricity|Wind"
    tmp <- as.data.frame(tmp[,c(1,2,3,7,4,5,6)])
    df <- rbind(df,tmp)
  }
}

aggregateMap <- list(
  "Secondary Energy|non VRE" = c("Secondary Energy|Electricity|Curtailment", "Secondary Energy|Electricity|Biomass", "Secondary Energy|Electricity|Coal", "Secondary Energy|Electricity|Gas", "Secondary Energy|Electricity|Geothermal", "Secondary Energy|Electricity|Hydro", "Secondary Energy|Electricity|Hydrogen", "Secondary Energy|Electricity|Nuclear", "Secondary Energy|Electricity|Oil", "Trade|Secondary Energy|Electricity|Volume"),
  "Secondary Energy|VRE" = c("Secondary Energy|Electricity|Solar", "Secondary Energy|Electricity|Wind"),
  "Final Energy|Fossil" = c("Final Energy|Gases|Fossil","Final Energy|Liquids|Fossil","Final Energy|Solids|Fossil"),
  "Final Energy|Non-Energy Use|Fossil" = c("Final Energy|Non-Energy Use|Gases|Fossil","Final Energy|Non-Energy Use|Liquids|Fossil","Final Energy|Non-Energy Use|Solids|Fossil"),
  "Final Energy|Industry|Fossil"       = c("Final Energy|Industry|Gases|Fossil","Final Energy|Industry|Liquids|Fossil","Final Energy|Industry|Solids|Fossil"),
  "Final Energy|Residential and Commercial|Fossil" = c("Final Energy|Residential and Commercial|Gases|Fossil","Final Energy|Residential and Commercial|Liquids|Fossil","Final Energy|Residential and Commercial|Solids|Fossil"),
  "Final Energy|Transportation|Fossil" = c("Final Energy|Transportation|Gases|Fossil","Final Energy|Transportation|Liquids|Fossil","Final Energy|Transportation|Solids|Fossil"),
  "Final Energy|Bunkers|Fossil"        = c("Final Energy|Bunkers|Gases|Fossil","Final Energy|Bunkers|Liquids|Fossil","Final Energy|Bunkers|Solids|Fossil"),
  "Final Energy|Other Sector|Fossil"   = c("Final Energy|Other Sector|Gases|Fossil","Final Energy|Other Sector|Liquids|Fossil","Final Energy|Other Sector|Solids|Fossil"),
   "Primary Energy|Fossil" = c("Primary Energy|Coal","Primary Energy|Gas","Primary Energy|Oil")
)
df <- df[!(df$Variable %in% names(aggregateMap)),] #remove aggregated variable alreayd reported
for(var in names(aggregateMap)){
  tmp <- NULL
  tmp <- df[df$Variable %in% aggregateMap[[var]],] %>%
          group_by(Model,Scenario,Region,Unit,Period) %>%
          summarize(Value = sum(Value, na.rm = TRUE),.groups="drop")
  tmp$Variable <- var
  tmp <- as.data.frame(tmp[,c(1,2,3,7,4,5,6)])
  df <- rbind(df,tmp)
}

for (model in unique(df$Model)){
  if (nrow(df[df$Variable %in% c("Carbon Removal|Land Use") & df$Model == model,]) != 0){
    for(scen in unique(df$Scenario)){
      if (nrow(df[df$Variable %in% c("Carbon Removal|Land Use") & df$Model == model & df$Scenario == scen,]) != 0){
    df <- rbind(df,
            df[df$Variable %in% c("Carbon Removal","Carbon Removal|Land Use") & df$Model == model  & df$Scenario == scen,] %>%
              group_by(Model,Scenario,Region,Unit,Period) %>%
              mutate(Value = Value - Value[Variable == 'Carbon Removal|Land Use']) %>% 
              filter(Variable == "Carbon Removal") %>%
              mutate(Variable = "Carbon Removal|Other")
            )
      }
    }
  }
}

GWP <- c("CO2"=1,"CH4"=28,"N2O"=265)

df <- rbind(df,
        df[df$Variable %in% c("Emissions|CH4"),] %>%
          group_by(Model,Scenario,Region,Unit,Period) %>%
          mutate(Value = Value * GWP["CH4"], Variable = "Emissions|Kyoto Gases|CH4")
        )

df <- rbind(df,
        df[df$Variable %in% c("Emissions|N2O"),] %>%
          group_by(Model,Scenario,Region,Unit,Period) %>%
          mutate(Value = Value * GWP["N2O"]/1000, Variable = "Emissions|Kyoto Gases|N2O")
        )

#reorder scenarios
df <- df %>%
  mutate(Scenario = factor(Scenario, levels=c(histScen,policyScen)))


#remove version from model names
df$Model <- gsub("v\\d*\\.?\\d*\\.?\\d*", "", df$Model) # remove "v1.0.0"
df$Model <- gsub("v\\d*\\.?\\d*", "", df$Model) # remove "v1.1"
df$Model <- gsub(" \\d*\\.?\\d*", "", df$Model) # remove "1.1"
df$Model <- gsub("\\s$*", "", df$Model) # remove trailing spaces
df$Model <- gsub("\\_*$", "", df$Model) # remove trailing underscores

#rename MESSAGE
df[df$Model == "MESSAGEix-GLOBIOM",]$Model <- "MESSAGE"





#Create Region aggregate for "OSeMBE v1.0.0" and "Euro-Calliope 2.0"
`EU27 & UK` <- c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark",
          "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy",
          "Latvia", "Lithuania", "Luxembourg", "Malta", "The Netherlands", "Poland", "Portugal",
          "Romania", "Slovakia", "Slovenia", "Spain", "Sweden",
          "United Kingdom"
          )
EU27regions <- `EU27 & UK`[`EU27 & UK` != "United Kingdom"]

# tmp <- df[(df$Model == "Euro-Calliope 2.0" & df$Region %in% `EU27 & UK`),]
# tmp <- tmp[!(tmp$Unit %in% c("US$2010/kW/yr","billion US$2010/yr","EUR/MWh")) ,]
# tmp <- tmp %>% group_by(Model,Scenario,Variable, Unit, Period) %>%
#   summarize(Value = sum(Value))
# tmp$Region <- "EU27 & UK"
# tmp <- as.data.frame(tmp[,c(1,2,7,3,4,5,6)])
# 
# df <- rbind(df,tmp)
#
# tmp <- df[(df$Model == "Euro-Calliope 2.0" & df$Region %in% EU27regions),]
# tmp <- tmp[!(tmp$Unit %in% c("US$2010/kW/yr","billion US$2010/yr","EUR/MWh")) ,]
# tmp <- tmp %>% group_by(Model,Scenario,Variable, Unit, Period) %>%
#   summarize(Value = sum(Value))
# tmp$Region <- "EU27"
# tmp <- as.data.frame(tmp[,c(1,2,7,3,4,5,6)])
#
#df <- rbind(df,tmp)

tmp <- df[(df$Model == "OSeMBE" & df$Region %in% `EU27 & UK`),]
tmp <- tmp[!(tmp$Unit %in% c("EUR_2020/GJ")) ,]
tmp <- tmp %>% group_by(Model,Scenario,Variable, Unit, Period) %>%
  summarize(Value = sum(Value))
tmp$Region <- "EU27 & UK"
tmp <- as.data.frame(tmp[,c(1,2,7,3,4,5,6)])

df <- rbind(df,tmp)

tmp <- df[(df$Model == "OSeMBE" & df$Region %in% EU27regions),]
tmp <- tmp[!(tmp$Unit %in% c("EUR_2020/GJ")) ,]
tmp <- tmp %>% group_by(Model,Scenario,Variable, Unit, Period) %>%
  summarize(Value = sum(Value))
tmp$Region <- "EU27"
tmp <- as.data.frame(tmp[,c(1,2,7,3,4,5,6)])

df <- rbind(df,tmp)

#adding share variables
df_quitte <- as.quitte(df)
addedVars <- df_quitte %>% calc_addVariable("`Final Energy|Hydrogen Share`" = "`Final Energy|Hydrogen` / `Final Energy`", units = "%", only.new=T)
addedVars <- rbind(addedVars,df_quitte %>% calc_addVariable("`Final Energy|Electricity Share`" = "`Final Energy|Electricity` / `Final Energy`", units = "%", only.new=T))
addedVars <- rbind(addedVars,df_quitte %>% calc_addVariable("`Secondary Energy|VRE Share`" = "`Secondary Energy|VRE` / `Secondary Energy|Electricity`", units = "%", only.new=T))
addedVars <- rbind(addedVars,df_quitte %>% calc_addVariable("`Primary Energy|Fossil Share`" = "`Primary Energy|Fossil` / `Primary Energy`", units = "%", only.new=T))
addedVars <- rbind(addedVars,df_quitte %>% calc_addVariable("`Primary Energy|Biomass Share`" = "`Primary Energy|Biomass` / `Primary Energy`", units = "%", only.new=T))
addedVars <- rbind(addedVars,df_quitte %>% calc_addVariable("`Secondary Energy|Electricity|Nuclear Share`" = "`Secondary Energy|Electricity|Nuclear` / `Secondary Energy|Electricity`", units = "%", only.new=T))
addedVars <- rbind(addedVars,df_quitte %>% calc_addVariable("`CO2 Intensity|Electricity`" = "`Emissions|CO2|Energy|Supply|Electricity` / `Final Energy|Electricity`", units = "Mt CO2/yr per EJ/yr", only.new=T))
colnames(addedVars) = colnames(df)
df <- rbind(df,addedVars)

# changing Period to numeric
df$Period <- as.numeric(df$Period)

#select Regions
if(regionDisplayed=="EU27"){
  df <- df[((df$Region %in% c("EU27", "Europe", "Europe (excl. Turkey)", "Europe (incl. Turkey)") & !(df$Model == "Euro-Calliope") ) | (df$Model == "MEESA" & df$Region == "EU27 & UK") | (df$Model == "Euro-Calliope" & df$Region == "EU27")),]
} else if (regionDisplayed=="EU27 & UK"){
  df <- df[(df$Region %in% c("EU27 & UK", "Europe", "Europe (excl. Turkey)", "Europe (incl. Turkey)") & !(df$Model == "Euro-Calliope") ) | (df$Model == "Euro-Calliope" & df$Region == "Europe"),] 
}

#order of Models
modelsOrder <- c("Euro-Calliope", "IMAGE", "MEESA", "MESSAGE", "OSeMBE", "PROMETHEUS", "REMIND", "TIAM-ECN", "WITCH") #,"PRIMES"
df$Model <- factor(df$Model, levels = c("reference",modelsOrder))

#order of scenarios
df$Scenario <- factor(df$Scenario, levels=c(histScen,policyScen))

#report number of vars per model
# nVars <- NULL
# for (model in unique(df$Model)){
#   n <- length(unique(df[df$Model == model,]$Variable))
#   names(n) = model
#   nVars <- c(nVars, n)
# }

saveRDS(df, paste0("../output/",type, "_", regionDisplayed, "_", length(selectedScenarios), ".rds"))

# type <- "NPIhist"
# regionDisplayed <- "EU27 & UK"
# selectedScenarios <- c("DIAG-NPI", "DIAG-Base", "DIAG-C80-gr5", "DIAG-C0to80-gr5", "DIAG-C400-lin", "DIAG-NZero")
# df <- readRDS(paste0("./output/",type, "_", regionDisplayed, "_", length(selectedScenarios), ".rds"))
#eurostatLabel <- "2019 Eurostat"
#policyScen <- c("DIAG-NPI", "DIAG-Base", "DIAG-C80-gr5", "DIAG-C0to80-gr5", "DIAG-C400-lin", "DIAG-NZero")


# type <- "paradigmShift"
# regionDisplayed <- "EU27 & UK"
# selectedScenarios <- c("DIAG-NPI", "DIAG-C400-lin", "DIAG-C400-lin-HighVRE","DIAG-C400-lin-HighElectrification","DIAG-C400-lin-HighH2","DIAG-C400-lin-ResidualFossil","DIAG-C400-lin-HighEff")
# df <- readRDS(paste0("../output/",type, "_", regionDisplayed, "_", length(selectedScenarios), ".rds"))
# eurostatLabel <- "2018 Eurostat"
# policyScen <- c("DIAG-NPI", "DIAG-C400-lin", "DIAG-C400-lin-HighVRE","DIAG-C400-lin-HighElectrification","DIAG-C400-lin-HighH2","DIAG-C400-lin-ResidualFossil","DIAG-C400-lin-HighEff")
# forceSave <- TRUE
# 
# regChosen <- regionDisplayed
# if(regChosen=="EU27 & UK") regChosen = "EU28"
# 
# 
# #rename supply side models to be at the end of the plots (adding x to start of them)
# df$Model <- as.character(df$Model)
# df[df$Model == "OSeMBE",]$Model <- "x OSeMBE"
# df[df$Model == "MEESA",]$Model <- "x MEESA"
# modelsOrder <- c("Euro-Calliope", "IMAGE", "MESSAGE", "PROMETHEUS", "REMIND", "TIAM-ECN", "WITCH", "x MEESA", "x OSeMBE") #,"PRIMES"
# df$Model <- factor(df$Model, levels = c("reference",modelsOrder))



```


<!-- Aesthetics -->
```{r aestetics, echo=FALSE, include=FALSE}

#knitr::opts_chunk$set(echo = TRUE)
# setting global R chunk options (https://yihui.name/knitr/options/#chunk_options)
  knitr::opts_chunk$set(dev='svglite', # svg, png,...
                        fig.ext = ".svg",
                        #fig.asp = .8 # default aspect ratio
                        fig.width = 16,
                        fig.height = 9,
                        dpi=100
                        )

color <- c(
#model
  "IMAGE" = "#00ffff",
  "Euro-Calliope" = "#c0c0c0",
  "MEESA" = "#ff00ff",
  "x MEESA" = "#ff00ff",
  "MESSAGE" = "#800080",
  "OSeMBE" = "#a52a2a",
  "x OSeMBE" = "#a52a2a",
  "PRIMES" = "#0000ff",
  "PROMETHEUS" = "#ffd900",
  "REMIND" = "#ff6347",
  "TIAM-ECN" = "#4682b4",
  "WITCH" = "#228b22",
#scenario
  "DIAG-Base" = "#f1746e",
  "DIAG-NPI" = "#b49f06",
  "DIAG-C80-gr5" = "#2eba38",
  "DIAG-C0to80-gr5" = "#38c0c4",
  "DIAG-C400-lin" = "#939dff",
  "DIAG-NZero" = "#f062e4",

  "DIAG-C400-lin-LimBio" = "#005900",
  "DIAG-C400-lin-LimCCS" = "#999959",
  "DIAG-C400-lin-LimNuclear" = "#ff33ff",
  
  "DIAG-C400-lin-HighVRE" = "#337fff",
  "DIAG-C400-lin-HighElectrification" = "#ffb200",
  "DIAG-C400-lin-HighH2" = "#5ed5b0",
  "DIAG-C400-lin-ResidualFossil" = "#cccccc",
  "DIAG-C400-lin-HighEff" = "#2eba38",

#emi
  "Energy Supply" = "#3D4849",
  "Energy Supply - Elect and Heat" = "#FF6600",
  "Energy Supply - Electricity"= "#ffb200",
  "Energy Supply - Heat"= "#cc0000",
  "Energy Supply - Fuels" = "#4D4D93",
  "Energy Supply - Gases"= "#999959",
  "Energy Supply - Liquids"= "#0000cc",
  "Energy Supply - Solids"= "#0c0c0c",
  "Energy Supply - Other" = "#79a6d2",
  "Energy Supply - Hydrogen" = "#5ed5b0",
  "Energy Demand" = "#999959",
  "Energy Demand - Transportation" = "#a1dd70",
  "Energy Demand - Bunkers" = "#ffc0cb",
  "Energy Demand - Buildings" = "#5edfff",
  "Energy Demand - Residential and Commercial" = "#5edfff",
  "Energy Demand - Other Sector" = "#999959",
  "Demand - AFOFI" = "#005900",
  "Energy Demand - Industry" = "#5f6769",
  "Industrial Processes" = "#b2b2b2",
  "Other" = "#5b0d8f",
  "Waste" = "#A52A2A",
  "AFOLU" = "#4DAF4A",
#capture
  "CCS" = "#cccccc",
  "CCS - Biomass" = "#008c00",
  "CCS - Biomass Energy" = "#005900",
  "CCS - Biomass Industry" = "#377EB8",
  "CCS - Biomass Industrial Processes" = "#79a6d2",
  "CCS - Fossil" = "#cccccc",
  "CCS - Fossil Energy" = "#a6a6a6",
  "CCS - Fossil Industry" = "#4e4e4e",
  "CCS - Fossil Industrial Processes" = "#282828",
  "DAC" = "#CC6666",
  "Enhanced Weathering" = "#5b0d8f",
  "Land Use" = "#4DAF4A",
  "Other" = "#79a6d2",
#carrier
  "Electricity" = "#ffb200",
  "Heat"        = "#cc0000",
  "Hydrogen"    = "#5ed5b0",
  "Gases"       = "#999959",
  "Gases - Fossil"  = "#999959", # #a1a161",
  "Gases - Biomass" = "#005900", # "#999959",
  "Gases - Electricity"  = "#ffb200", # "#caca8a",
  "Liquids"     = "#0000cc",
  "Liquids - Fossil"  = "#0000cc", #"#000068",
  "Liquids - Biomass" = "#005900", #"#0000cc",
  "Liquids - Electricity"   = "#ffb200", #"#5050ff",
  "Solids"      = "#0c0c0c",
  "Solids - Fossil"  = "#0c0c0c",
  "Solids - Biomass" = "#005900",
  "Other Carrier" = "#79a6d2",
  "Geothermal" = "#e51900",
  "Solar" = "#ffcc00",
#sector
  "Non-Energy Use" = "#ff9966",
  "Industry" = "#5f6769",
  "Residential and Commercial" = "#5edfff",
  "Transportation" = "#a1dd70",
  "Bunkers" = "#ffc0cb",
  "Other Sector" = "#999959",
#sector fe carrier
  "Non-Energy Use - Hydrogen" = "#5ed5b0",
  "Non-Energy Use - Gases" = "#999959",
  "Non-Energy Use - Liquids" = "#0000cc",
  "Non-Energy Use - Solids" = "#0c0c0c",
  "Non-Energy Use - Other" = "#79a6d2",
  "Industry - Electricity" = "#ffb200",
  "Industry - Heat" = "#cc0000",
  "Industry - Hydrogen" = "#5ed5b0",
  "Industry - Gases" = "#999959",
  "Industry - Liquids" = "#0000cc",
  "Industry - Solids" = "#0c0c0c",
  "Industry - Other" = "#79a6d2",
  "Transport - Electricity" = "#ffb200",
  "Transport - Hydrogen" = "#5ed5b0",
  "Transport - Gases" = "#999959",
  "Transport - Liquids" = "#0000cc",
  "Transport - Other" = "#79a6d2",
  "Bunkers - Electricity" = "#ffb200",
  "Bunkers - Hydrogen" = "#5ed5b0",
  "Bunkers - Gases" = "#999959",
  "Bunkers - Liquids" = "#0000cc",
  "Bunkers - Other" = "#79a6d2",
#sector per type
  "Passenger" = "#77c3e6",
  "Freight" = "#37474f",
#tech
  "Solar" = "#ffcc00",
  "Solar CSP" = "#ffcc00",
  "Solar PV" = "#ffe600",
  "Wind" = "#337fff",
  "Wind Offshore" = "#4d33ff",
  "Wind Onshore" = "#337fff",
  "Other" = "#5b0d8f",
  "Ocean" = "#0000FF",
  "Biomass" = "#005900",
  "Biomass w/ CCS" = "#33ff00",
  "Biomass w/o CCS" = "#005900",
  "Hydro" = "#191999",
  "Hydro Reservoir" = "#8a8aec",
  "Hydro Pumped Storage" = "#dfdffa",
  "Hydro Run of River" = "#191999",
  "Geothermal" = "#e51900",
  "Nuclear" = "#ff33ff",
  "Gas" = "#999959",
  "Gas CCGT" = "#7c6b2a",
  "Gas w/ CCS" = "#b79e38",
  "Gas w/o CCS" = "#999959",
  "Coal" = "#0c0c0c",
  "Coal w/ CCS" = "#b2b2b2",
  "Coal w/o CCS" = "#0c0c0c",
  "Oil" = "#b30000",
  "Oil w/ CCS" = "#ff6565",
  "Oil w/o CCS" = "#b30000",

  "VRE" = "#337fff",
  "non VRE" = "#ececec",

  "Hydrogen w/ CCS"="#86e0c4",
  "Hydrogen w/o CCS"="#5ed5b0",
  "Electricity w/ CCS"="#ffc133",
  "Electricity w/o CCS"="#ffb200",  
  "Liquids w/ CCS" = "#0000ff",
  "Liquids w/o CCS" = "#0000cc",

  #Carbon management
  "Direct Air Capture" = "#24A19C",
  "Fossil" = "#cccccc",
  "Storage" = "#D96098",
  "Usage" = "#325288",
  #Kyoto Gases
  "CO2" = "#7e7e7e",
  "CH4" = "#ffe7a0",
  "N2O" = "#44ba97",
  "F-Gases" = "#ff9977"
)

alpha = c(
  #hist
  "EU27Ref" = 0.4,
  "Eurostat" = 1,
  "IMF" = 1,           
  "2019 Eurostat" = 1
)

#plot aesthetics
theme_singleColumn <- function(){
  theme_minimal(base_size = 16) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle=90, hjust = 1, vjust = 0.5),
    legend.position="bottom",
    legend.title=element_blank(),
    legend.key.size = unit(20,"pt"),
    legend.text = element_text(size=14, margin = margin(r = 20, unit = 'pt')),
    panel.spacing = unit(1.5, "lines")
  )
}


theme_singlePlot <- function(){
  theme_minimal(base_size = 16*1.5) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle=90, hjust = 1, vjust = 0.5),
    legend.position="bottom",
    legend.title=element_blank(),
    legend.key.size = unit(20*2,"pt"),
    legend.text = element_text(size=14*2)
  )
}

```

<!-- Creating Plots -->

```{r auxilir_plot_functions, echo=FALSE, include=FALSE}

# function to create line plots
linePlot <- function(data, scen=policyScen, title="", colorDim="Model", linetypeDim=NULL, xdim="Period", ydim="Value", facetDim="Scenario", legend = list(nrow=NULL), min=0, max=NULL, minPeriod=2005, maxPeriod=2050, labels=NULL, facet = list(nrow=NULL,ncol=2), percentage=FALSE, saveFile=FALSE, saveFolder=""){

  if(nrow(data)==0){
    return(NULL)
  }

  data <- data[(data$Period >= minPeriod) & (data$Period <= maxPeriod),]
  plotData <- data[((!(data$Model=="reference")) & (data$Scenario %in% scen)),]
  plotData$Scenario <- factor(plotData$Scenario , levels = scen)
  plotData$Model <- factor(plotData$Model, level = levels(plotData$Model)[!levels(plotData$Model) == c("reference")])

  hist <- data[(data$Model=="reference"),]

  if(!(nrow(hist)==0)){
    tmp <- hist
    tmp$source <- tmp$Scenario
    histFull <- NULL
    for(sc in scen){
      tmp$Scenario <- sc
      histFull <- rbind(histFull,tmp)
    }
    histLabel <- histFull %>%
      group_by(source, Region, Variable) %>%
      filter(Period == max(Period))
    histFull$Scenario <- factor(histFull$Scenario , levels = scen)
    histLabel$Scenario <- factor(histLabel$Scenario , levels = scen)
  }

  if(!(is.null(labels))){
      fullVars <- levels(data$Variable)
      names(fullVars) <- labels
      labelsVars <- fullVars[fullVars %in% unique(data$Variable)]
  }
  
  gg <- ggplot(plotData,aes_string(x=xdim ,y=ydim, color=colorDim ,linetype=linetypeDim)) +
    geom_hline(yintercept=0, color = "black", size=1, alpha = 0.15) +
    geom_vline(xintercept=2020, color = "black", size=1, alpha = 0.15, linetype = "dashed") +
    geom_line(size=1) +
    geom_point() +
    {if((facetDim=="Variable")) facet_wrap(facetDim,drop = FALSE, nrow=facet$nrow, ncol=facet$ncol, 
               labeller = labeller(Variable = 
                  function(Variable, Value) {
                    facetLabels <- setNames(names(labelsVars),labelsVars)
                    out <- facetLabels[Variable]
                    return(out) 
                  }))} +
    # {if(!(nrow(hist)==0) & !(facetDim=="Model") & !is.null(linetypeDim)) geom_line(data=histFull,size=1,aes(group = source),color="black",alpha = 1,lty="11") } +
    # {if(!(nrow(hist)==0) & !(facetDim=="Model") & is.null(linetypeDim)) geom_line(data=histFull,size=1,aes(group = source),color="black",alpha = 1,lty="11") } +
    {if(!(nrow(hist)==0) & !(facetDim=="Model")) geom_line(data=histFull,size=1,aes(alpha = source),color="black") } + #,lty="11" 
    {if(!(nrow(hist)==0) & !(facetDim=="Model")) geom_point(data=histFull,size=1, stroke = 1.5,shape=4,aes(alpha = source),color="black") } +
    {if(!(nrow(hist)==0) & !(facetDim=="Model")) geom_text(data=histLabel, aes(label = source), color="black", hjust ="inward", vjust=1.5) } +
    {if(!(nrow(hist)==0) & !(facetDim=="Model")) scale_alpha_manual(values = as.numeric(alpha[unique(histFull$source)]),guide="none") } +
    {if(!(facetDim=="Variable")) facet_wrap(facetDim,drop = FALSE, nrow=facet$nrow, ncol=facet$ncol)} +
    theme_singleColumn() +
    theme(
      legend.key.size = unit(30,"pt"),
      legend.text = element_text(size=16, margin = margin(r = 20, t = 10, b = 10, unit = 'pt'))
    ) +
    ylab(title) +
    #scale_x_continuous(breaks=seq(2010, 2050, 10)) +
    {if(!is.null(legend$nrow)) guides(color = guide_legend(nrow = legend$nrow),linetype = guide_legend(nrow = legend$nrow))} +
    {if(!(is.null(max))) coord_cartesian(ylim=c(NA, max))} +
    {if(!(is.null(min))) expand_limits(y=c(min))} +
    {if(percentage) scale_y_continuous(labels = scales::percent_format(accuracy = 1)) }
  
  if(colorDim=="Variable"){
    if(!(is.null(labels))){
      fullVars <- levels(data$Variable)
      names(fullVars) <- labels
      vars <- fullVars[unique(data$Variable)]
      gg <- gg + scale_color_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars),vars),drop=FALSE)
    }
  } else {
    lvl <- levels(plotData[[colorDim]])
    lvl <- lvl[lvl!="reference"]
    gg <- gg +
      scale_color_manual(values = setNames(color[lvl],lvl),drop=FALSE)
  }
  
  if(saveFile){
      
    dir.create(saveFolder, recursive = T, showWarnings = FALSE)
    
    if(facetDim=="Variable"){
      varName <- setNames(names(labelsVars),labelsVars)
    }
    
    lapply(unique(plotData[[facetDim]]),function(selectedFacet){
      singlePlotData <- plotData[plotData[[facetDim]]==selectedFacet,]
      
      g <- ggplot(singlePlotData,aes_string(x=xdim ,y=ydim, color=colorDim ,linetype=linetypeDim)) +
      geom_hline(yintercept=0, color = "black", size=1, alpha = 0.15) +
      geom_vline(xintercept=2020, color = "black", size=1, alpha = 0.15, linetype = "dashed") +
      geom_line(size=1) +
      geom_point() +
      {if(!(nrow(hist)==0) & !(facetDim=="Model")) geom_line(data=histFull,size=1,aes(alpha = source),color="black") } + #,lty="11" 
      {if(!(nrow(hist)==0) & !(facetDim=="Model")) geom_point(data=histFull,size=1, stroke = 1.5,shape=4,aes(alpha = source),color="black") } +
      {if(!(nrow(hist)==0) & !(facetDim=="Model")) geom_text(data=histLabel, aes(label = source), color="black", hjust ="inward", vjust=1.5, size = 6) } +
      {if(!(nrow(hist)==0) & !(facetDim=="Model")) scale_alpha_manual(values = as.numeric(alpha[unique(histFull$source)]),guide="none") } +
      theme_singlePlot() +
      #theme(
      #  legend.key.size = unit(30,"pt"),
      #  legend.text = element_text(size=16, margin = margin(r = 20, t = 10, b = 10, unit = 'pt'))
      #) +
      ylab(title) +
      #scale_x_continuous(breaks=seq(2010, 2050, 10)) +
      {if(!is.null(legend$nrow)) guides(color = guide_legend(nrow = legend$nrow),linetype = guide_legend(nrow = legend$nrow))} +
      {if(!(is.null(max))) coord_cartesian(ylim=c(NA, max))} +
      {if(!(is.null(min))) expand_limits(y=c(min))} +
      {if(percentage) scale_y_continuous(labels = scales::percent_format(accuracy = 1)) }
    
      if(colorDim=="Variable"){
        if(!(is.null(labels))){
          fullVars <- levels(data$Variable)
          names(fullVars) <- labels
          vars <- fullVars[unique(data$Variable)]
          g <- g + scale_color_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars),vars),drop=FALSE)
        }
      } else {
        lvl <- levels(plotData[[colorDim]])
        lvl <- lvl[lvl!="reference"]
        g <- g +
          scale_color_manual(values = setNames(color[lvl],lvl),drop=FALSE)
      }
      
      ggsave(paste0(saveFolder, "/", regChosen, "_", ifelse(facetDim=="Variable",varName[selectedFacet],gsub("\\|","_", selectedFacet)), ".svg"), g, device="svg", width = 18, height = 12, dpi=100, units = "in")
      ggsave(paste0(saveFolder, "/", regChosen, "_", ifelse(facetDim=="Variable",varName[selectedFacet],gsub("\\|","_", selectedFacet)), ".png"), g, device="png", width = 18, height = 12, dpi=100, units = "in")
     
    })
  }
   
  return(gg)
}

# function to create bar Plots
barPlot <- function(data, scen=policyScen,total=NULL,period=c(2020,2030,2050),title="", legend = list(nrow=NULL), min=0, max=NULL, labels=NULL, pattern=NULL, facet = list(nrow=NULL,ncol=6), saveFile=FALSE, saveFolder=""){

  if(nrow(data)==0){
    return(NULL)
  }

  plotData <- data[((!(data$Model=="reference")) & (data$Scenario %in% scen)),]
  plotData <- plotData[(plotData$Period %in% period),]
  plotData$Scenario <- factor(plotData$Scenario , levels = scen)
  plotData$Model <- factor(plotData$Model, level = levels(plotData$Model)[!levels(plotData$Model) == c("reference")])

  if(nrow(plotData)==0){
    return(NULL)
  }
  
  tmp <- total[(total$Period %in% period) & (total$Model == "reference"),]
  tmp$Model <- tmp$Scenario
  histTotal <- NULL
  for(sc in scen){
    tmp$Scenario <- sc
    histTotal <- rbind(histTotal,tmp)
  }
  plotTotal <- rbind(histTotal,total[((total$Period %in% period) & (total$Scenario %in% scen) & !(total$Model == "reference")),])
  plotTotal$Scenario <- factor(plotTotal$Scenario , levels = scen)
  #plotTotal$Model <- factor(plotTotal$Model, level = levels(plotData$Model))
  plotTotal$Model <- as.character(plotTotal$Model) # clear factor

  hist <- data[(data$Model=="reference") & (data$Period %in% period),]

  if(!(nrow(hist)==0)){
    tmp <- hist
    tmp$Model <- tmp$Scenario
    histFull <- NULL
    for(sc in scen){
      tmp$Scenario <- sc
      histFull <- rbind(histFull,tmp)
    }
    histFull$Scenario <- factor(histFull$Scenario , levels = scen)
    histFull$Model <- as.character(histFull$Model) #remove factor
  }

  if(!(is.null(labels))){
      fullVars <- levels(data$Variable)
      names(fullVars) <- labels
      labelsVars <- fullVars[fullVars %in% unique(data$Variable)]
  }

  if(!(is.null(pattern))){
      fullVars <- levels(data$Variable)
      names(fullVars) <- pattern
      patternVars <- fullVars[fullVars %in% unique(data$Variable)]
  }

  nPer <- length(unique(plotData$Period)) 
  if(!(is.null(facet$ncol))){
    plotsPerLine <- facet$ncol
  } else {
    plotsPerLine <- (length(scen)*nPer)/facet$nrow
  }
  numberOfLines <- ceiling((length(scen)*nPer)/plotsPerLine)
  
  gg <- ggplot(plotData,aes(x=Model,y=Value,fill=Variable,pattern=Variable)) +
    geom_hline(yintercept=0, color = "black", size=1, alpha = 0.15) +
    {if(!(nrow(hist)==0) & is.null(pattern)) geom_bar(data=histFull,stat='identity', alpha = 0.6)} +
    {if(!(nrow(hist)==0) & !is.null(pattern)) geom_bar_pattern(data=histFull,stat='identity', pattern_key_scale_factor = 0.3, pattern_density=ifelse((numberOfLines==1), 0.5/3, 0.5), pattern_spacing = 0.03, pattern_colour = "white", pattern_fill = "white", pattern_alpha=0.4, alpha = 0.6)} +
    {if(is.null(pattern)) geom_bar(stat='identity')} +
    {if(!is.null(pattern)) geom_bar_pattern(stat='identity', pattern_key_scale_factor = 0.3,  pattern_density=ifelse((numberOfLines==1), 0.5/3, 0.5), pattern_spacing = 0.03, pattern_colour = "white", pattern_fill = "white", pattern_alpha=0.4)} +
    {if(nrow(plotTotal)>0) geom_point(data=plotTotal,aes(x=Model,y=Value), shape=23,fill="black",color="white", alpha = 0.7,show.legend = F, size = 2, stroke = 2)} +
    theme_singleColumn() +
    facet_wrap(~Scenario+Period, scales='free_x', nrow=facet$nrow, ncol=facet$ncol, 
               labeller = labeller(Scenario = 
                  function(Variable, Value) {
                    if(nPer==1){
                      out <- Variable
                    } else {
                     out <- rep("",length(scen)*nPer)
                      for (i in 1:length(scen)){
                        out[(((i-1)*nPer)+2)] <- Variable[(((i-1)*nPer)+2)]
                      }
                    }
                    return(out) 
                  }),drop = FALSE) +
    scale_x_discrete(drop=FALSE) +
    {if(!is.null(labels)) scale_fill_manual(values = setNames(color[names(labelsVars)],labelsVars), labels = setNames(names(labelsVars),labelsVars),drop=FALSE) } +
    {if(!is.null(pattern)) scale_pattern_manual(values = setNames(c("none",names(patternVars)),c("Total",patternVars)))} +
    {if(!is.null(pattern)) guides(fill = guide_legend(override.aes = list(pattern = setNames(names(patternVars),patternVars) ) ) )} +
    {if(!is.null(pattern)) guides(pattern="none")} +
    ylab(title) +
    {if(numberOfLines > 2) theme(axis.text.x = element_text(size = 10))} +
    {if(!is.null(legend$nrow)) guides(fill = guide_legend(nrow = legend$nrow))} +
    {if(is.null(max)) expand_limits(y=c(min))} +
    {if(!(is.null(max))) expand_limits(y=c(min,max))} 
  
  if((numberOfLines==1) & (length(scen)==1)){
    gg <- gg + theme(panel.spacing = unit(1.5*3, "lines"))
  }
  
  layoutPos <- NULL
  for (i in 1:(plotsPerLine/nPer)){
    layoutPos[i] <- 15 + 12*(i-1)
  }
  gg <- spaceFacet(gg,layout=layoutPos)
  
  if(saveFile){
      
    dir.create(saveFolder, recursive = T, showWarnings = FALSE)
    
    facetDim <- "Scenario"
    lapply(unique(plotData[[facetDim]]),function(selectedFacet){
      singlePlotData <- plotData[plotData[[facetDim]]==selectedFacet,]
      if(!(nrow(hist)==0)) singleHistData <- histFull[histFull[[facetDim]]==selectedFacet,]
      if(nrow(plotTotal)>0) singleplotTotal <- plotTotal[plotTotal[[facetDim]]==selectedFacet,]
      
      g <- ggplot(singlePlotData,aes(x=Model,y=Value,fill=Variable,pattern=Variable)) +
        geom_hline(yintercept=0, color = "black", size=1, alpha = 0.15) +
        {if(!(nrow(hist)==0) & is.null(pattern)) geom_bar(data=singleHistData,stat='identity', alpha = 0.6)} +
        {if(!(nrow(hist)==0) & !is.null(pattern)) geom_bar_pattern(data=singleHistData,stat='identity', pattern_key_scale_factor = 0.3, pattern_density=ifelse((numberOfLines==1), 0.5/3, 0.5), pattern_spacing = 0.03, pattern_colour = "white", pattern_fill = "white", pattern_alpha=0.4, alpha = 0.6)} +
        {if(is.null(pattern)) geom_bar(stat='identity')} +
        {if(!is.null(pattern)) geom_bar_pattern(stat='identity', pattern_key_scale_factor = 0.3,  pattern_density=ifelse((numberOfLines==1), 0.5/3, 0.5), pattern_spacing = 0.03, pattern_colour = "white", pattern_fill = "white", pattern_alpha=0.4)} +
        {if(nrow(singleplotTotal)>0) geom_point(data=singleplotTotal,aes(x=Model,y=Value), shape=23,fill="black",color="white", alpha = 0.7,show.legend = F, size = 3, stroke = 2)} +
        theme_singlePlot() +
        facet_wrap(~Period, scales='free_x', nrow=facet$nrow, ncol=facet$ncol,drop = FALSE) +
        scale_x_discrete(drop=FALSE) +
        {if(!is.null(labels)) scale_fill_manual(values = setNames(color[names(labelsVars)],labelsVars), labels = setNames(names(labelsVars),labelsVars),drop=FALSE) } +
        {if(!is.null(pattern)) scale_pattern_manual(values = setNames(c("none",names(patternVars)),c("Total",patternVars)))} +
        {if(!is.null(pattern)) guides(fill = guide_legend(override.aes = list(pattern = setNames(names(patternVars),patternVars) ) ) )} +
        #{if(!is.null(pattern)) guides(fill = guide_legend(override.aes = list(pattern = setNames(names(patternVars),patternVars)) , nrow = legend$nrow ) )} +
        {if(!is.null(pattern)) guides(pattern="none")} +
        ylab(title) +
        {if(numberOfLines > 2) theme(axis.text.x = element_text(size = 10))} +
        {if(!is.null(legend$nrow)) guides(fill = guide_legend(nrow = legend$nrow))} +
        {if(is.null(max)) expand_limits(y=c(min))} +
        {if(!(is.null(max))) expand_limits(y=c(min,max))} + 
        theme(legend.key.size = unit(1, 'cm'), legend.text = element_text(size=14))
      
      ggsave(paste0(saveFolder, "/", regChosen, "_", gsub("\\|","_", selectedFacet), ".svg"), g, device="svg", width = 18, height = 12, dpi=100, units = "in")
      ggsave(paste0(saveFolder, "/", regChosen, "_", gsub("\\|","_", selectedFacet), ".png"), g, device="png", width = 18, height = 12, dpi=100, units = "in")
     
    })
  }
  
  
  return(gg)
}

#function to space facets and remove crop from facet titles
spaceFacet <- function(gg,size=3,layout=c(15,27)){
  gt = ggplot_gtable(ggplot_build(gg))
  #gtable_show_layout(gt)
  for (item in layout){
    if(item <= length(gt$widths)){
        gt$widths[item] = size*gt$widths[item]
    }
  }
  #remove crop from titles
  for(i in which(grepl("strip-r|strip-t", gt$layout$name))){
    gt$grobs[[i]]$layout$clip <- "off"
  }
  return(as.ggplot(gt))
}


# function to filter data recursively
filterData <- function (data, plotName, l=plotList) {

  loopList <- function (lt, varList, dd) { # function to filter only vars that have values, in the highest node levels possible
    for (node in names(lt)){
      if(length(intersect(node,unique(dd$Variable)))==0){ #remove node if it has no data
        varList <- varList[varList != as.character(node)]
      }
      if(!(is.null(names(lt[[node]])))){ # node is not a terminal node
        if(length(intersect(unique(unlist((strsplit(names(unlist(lt[[node]])),"\\.")))),unique(dd$Variable)))>0){ #remove node if any children has data
          varList <- varList[varList != as.character(node)]
        }
        varList <- loopList(lt[[node]], varList, dd)
      }
    }
    return(varList)
  }

  vars <- unique(unlist((strsplit(names(unlist(l[[plotName]]$vars)),"\\."))))

  out <- do.call(rbind,
      lapply(unique(data$Model), function(model){
        do.call(rbind,
          lapply(unique(data$Scenario), function(scenario){
            return(data[data$Model == model & data$Scenario == scenario & data$Variable %in% loopList(lt=l[[plotName]]$vars, varList=vars, dd=data[data$Model == model & data$Scenario == scenario,]),])
          })
        )
      })
    )

  #out$Variable <- factor(out$Variable , levels = unique(unlist((strsplit(names(unlist(plotList[[plotName]]$vars)),"\\.")))))
  out$Variable <- factor(out$Variable , levels = vars)
  out$Model <- factor(out$Model , levels = levels(data$Model))
  out$Scenario <- factor(out$Scenario , levels = levels(data$Scenario))
  #intersect(unique(unlist((strsplit(names(unlist(plotList[[plotName]]$vars)),"\\.")))),unique(out$Variable))) #order

  return(out)

}


```


```{r creating_Plots, echo=FALSE, include=FALSE}

# reading json file that define all plots
plotList <- fromJSON("plots.json")
#plotList <- fromJSON("./R/plots.json")
#plot <- "CO2 Emissions"

# creating all plots from JSON specification
g <- NULL
g <-
  lapply(names(plotList),function(plot){
    print(plot)
    #overwrite save file option
    if(forceSave){
      plotList[[plot]]$arg$saveFile <- TRUE
    }
    if(plotList[[plot]]$type == "line"){
      if((type=="paradigmShift" || type=="techConstraint") & (!("scen" %in% names(plotList[[plot]]$arg)))){
        d <- filterData(data=df[!(df$Scenario %in% c(paste0(" ", eurostatLabel),"DIAG-NPI")),],plotName=plot)   # filtering data for plot
        p <- do.call(linePlot, c(list(data=d,saveFolder=paste0("../output/charts/", type , "/" , plot),scen=policyScen[!(policyScen=="DIAG-NPI")]),plotList[[plot]]$arg))
      } else {
        d <- filterData(data=df[!(df$Scenario %in% c(paste0(" ", eurostatLabel))),],plotName=plot)   # filtering data for plot  
        p <- do.call(linePlot, c(list(data=d,saveFolder=paste0("../output/charts/", type , "/" , plot)),plotList[[plot]]$arg))
      }
    } else if (plotList[[plot]]$type == "bar"){
      if((type=="paradigmShift" || type=="techConstraint") & (!("scen" %in% names(plotList[[plot]]$arg)))){
        d <- filterData(data=df[!(df$Scenario %in% c("DIAG-NPI")),],plotName=plot)   # filtering data for plot
        totalSum <- df[(df$Variable %in%  names(plotList[[plot]]$vars)),] %>%
          group_by(Model,Scenario,Period) %>% summarize(Value = sum(Value),.groups="drop") %>% mutate(Variable="Total")
        p <- do.call(barPlot, c(list(data=d,total=totalSum,saveFolder=paste0("../output/charts/", type , "/" , plot),scen=policyScen[!(policyScen=="DIAG-NPI")]),plotList[[plot]]$arg))
      } else {
        d <- filterData(data=df,plotName=plot)    # filtering data for plot
        totalSum <- df[(df$Variable %in%  names(plotList[[plot]]$vars)),] %>%
          group_by(Model,Scenario,Period) %>% summarize(Value = sum(Value),.groups="drop") %>% mutate(Variable="Total")
        p <- do.call(barPlot, c(list(data=d,total=totalSum,saveFolder=paste0("../output/charts/", type , "/" , plot)),plotList[[plot]]$arg))
      }
    }
    return(p)
  })
names(g) <- names(plotList)

```


<!-- Display Plots -->

```{r, echo = FALSE, results='asis', fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}
if(type=="techConstraint"){
  
  out = "# Summary {.tabset}\n\n";
  out = paste0(out,"## LimBio\n\n");
  out = paste0(out,"### Biomass Primary Energy Share\n\n");
  
  cat(out)
  
  print(g$`limBio - Biomass Primary Energy Share`)
  
  out = "\n\n";
  out = paste0(out,"### Biomass Primary Energy\n\n");
  
  cat(out)
  
  print(g$`limBio - Biomass Primary Energy`)
  
  out = "\n\n";
  out = paste0(out,"### Biomass Secondary Energy\n\n");
  
  cat(out)
  
  print(g$`limBio - Biomass Secondary Energy`)
  
  out = "\n\n";
  out = paste0(out,"## limCCS\n\n");
  out = paste0(out,"### Carbon Storage\n\n");
  
  cat(out)
  
  print(g$`limCCS - Carbon Storage`)
  
  out = "\n\n";
  out = paste0(out,"### Carbon Storage per source\n\n");
  
  cat(out)
  
  print(g$`limCCS - Carbon Storage per source`)
  
  out = "\n\n";
  out = paste0(out,"## limNuclear\n\n");
  out = paste0(out,"### Nuclear Electricity Share\n\n");
  
  cat(out)
  
  print(g$`limNuclear - Nuclear Electricity Share`)
  
  out = "\n\n";
  out = paste0(out,"### Nuclear Primary Energy\n\n");
  
  cat(out)
  
  print(g$`limNuclear - Nuclear Primary Energy`)
  
  out = "\n\n";
  out = paste0(out,"### Nuclear Electricity\n\n");
  
  cat(out)
  
  print(g$`limNuclear - Nuclear Electricity`)
   
}
```




```{r, echo = FALSE, results='asis', fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}
if(type=="paradigmShift"){
  
  out = "# Summary {.tabset}\n\n";
  out = paste0(out,"## HighVRE\n\n");
  out = paste0(out,"### VRE Electricity Share\n\n");
  
  cat(out)
  
  print(g$`HighVRE - VRE Electricity Share`)
  
  out = "\n\n";
  out = paste0(out,"### Total VRE Electricity\n\n");
 
  cat(out)
  
  
  print(g$`HighVRE - Total VRE Electricity`)
  
  
  out = "\n\n";
  out = paste0(out,"### VRE Electricity per tech\n\n");
 
  cat(out)
  
  
  print(g$`HighVRE - VRE Electricity per tech`)
  
  
  out = "\n\n";
  out = paste0(out,"## HighElectrification\n\n");
  
  out = paste0(out,"### Electricity Share in Final Energy\n\n");
  
  cat(out)
  
  print(g$`HighElec - Electricity Share in Final Energy`)
  
  
  out = "\n\n";
  out = paste0(out,"### Total Electricity\n\n");
  
  cat(out)
  
  print(g$`HighElec - Total Electricity`)
  
  
  out = "\n\n";
  out = paste0(out,"### Electricity Final Energy per sector\n\n");
  
  cat(out)
  
  print(g$`HighElec - Electricity Final Energy per sector`)
  
  
  out = "\n\n";
  out = paste0(out,"## HighH2\n\n");
  out = paste0(out,"### Hydrogen Share in Final Energy\n\n");
  
  cat(out)
  
  print(g$`HighH2 - Hydrogen Share in Final Energy`)
  
  
  out = "\n\n";
  out = paste0(out,"### Total Hydrogen\n\n");
  
  cat(out)
  
  print(g$`HighH2 - Total Hydrogen`)
  
  out = "\n\n";
  out = paste0(out,"### Hydrogen Final Energy per sector\n\n");
  
  cat(out)
  
  print(g$`HighH2 - Hydrogen Final Energy per sector`)
  
  out = "\n\n";
  out = paste0(out,"## Residual Fossil\n\n");
  out = paste0(out,"### Fossil Primary Energy Share\n\n");
  
  cat(out)
  
  print(g$`Residual Fossil - Fossil Primary Energy Share`)
  
  out = "\n\n";
  out = paste0(out,"### Fossil Primary Energy\n\n");
  
  cat(out)
  
  print(g$`Residual Fossil - Fossil Primary Energy`)
  
  out = "\n\n";
  out = paste0(out,"### Fossil Primary Energy per source\n\n");
 
  cat(out)
  
  print(g$`Residual Fossil - Fossil Primary Energy per source`)
  
  out = "\n\n";
  out = paste0(out,"## High Efficiency\n\n");
  out = paste0(out,"### Final Energy\n\n");
  
  cat(out)
  
  print(g$`HighEff - Final Energy`)
  
  
  out = "\n\n";
  out = paste0(out,"### Final Energy per sector\n\n");
 
  cat(out)
  
  print(g$`HighEff - Final Energy per sector`)

}
```


---

# Emissions {.tabset}

## CO2

### CO2 Emissions

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`CO2 Emissions`

```

---

## per source

### CO2 Emissions per source

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`CO2 emissions per source`

```


<!-- --- -->

<!-- ## NPI hist per source -->

<!-- ### NPI Historical Emissions per source -->


```{r, echo = FALSE, results='asis', fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}
if(type=="NPIhist"){
  
  out = "---\n\n";
  out = paste0(out,"## NPI hist per source\n\n");
  out = paste0(out,"### NPI Historical Emissions per source\n\n");
  
  cat(out)
  
  print(g$`NPI Historical CO2 emissions per source`)
}
```

---

## energy and indProcesses

### Energy and Industrial Processes CO2 Emissions

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Energy and Industrial Processes CO2 Emissions`

```

---

## energy and indProcesses detailed

### Energy and Industrial Processes CO2 Emissions detailed

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Energy and Industrial Processes CO2 Emissions detailed`

```

---

## Kyoto Gases

### Kyoto Gases Emissions

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Kyoto Gases Emissions`

```

---

## per source

### Kyoto Gases emissions per source

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Kyoto Gases emissions per source`

```


---

## per gases

### Kyoto Gases emissions per gases

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Kyoto Gases emissions per gases`

```

---

## energy and indProcesses

### Energy and Industrial Processes Kyoto Gases

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Energy and Industrial Processes Kyoto Gases`

```

---

## CH4

### CH4 emissions

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`CH4 Emissions`

```

---

## N2O

### N2O emissions

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`N2O Emissions`

```

---

## F-Gases

### F-Gases emissions

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`F-Gases Emissions`

```

---

# Carbon Price {.tabset}

## Carbon Price per scenario

### per scenario

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Carbon Price (per scenario)`

```

---

## Carbon Price per model

### per model

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Carbon Price (per model)`

```

---


# Carbon Capture {.tabset}

## Carbon Capture

### Carbon Capture

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Carbon Capture`

```

---

## per source

### Carbon Capture per source

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Carbon Capture per source`

```


---

## Carbon Storage and Usage

### Carbon Storage and Usage

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Carbon Storage and Usage`

```

---

## Carbon Removal

### Carbon Removal

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Carbon Removal`

```

---

## per type

### Carbon Removal per type

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Carbon Removal per type`

```

---

# Primary Energy {.tabset}

## Primary Energy

### Primary Energy

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Primary Energy`

```

---

## per source

### Primary Energy per source

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Primary Energy per source`

```

<!-- --- -->

<!-- ## NPI hist per source -->

<!-- ### NPI Historical Primary Energy per source -->

```{r, echo = FALSE, results='asis', fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}
if(type=="NPIhist"){
  
  out = "---\n\n";
  out = paste0(out,"## NPI hist per source\n\n");
  out = paste0(out,"### NPI Historical Primary Energy per source\n\n");
  
  cat(out)
  
  print(g$`NPI Historical Primary Energy per source`)
}
```


---

## Trade

### Primary Energy Trade

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Primary Energy Trade`

```

---

# Primary Energy Prices {.tabset}

## Primary Energy Prices

### Primary Energy Prices per source

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Primary Energy Price per source`

```

---

## per model

### Primary Energy Prices per model

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Primary Energy Price per model`

```

---


# Secondary Energy {.tabset}

## Secondary Energy

### Secondary Energy

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Secondary Energy`

```

---

## per carrier

### Secondary Energy per carrier

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Secondary Energy per carrier`

```

<!-- --- -->


<!-- ## NPI hist per carrier -->

<!-- ### NPI Historical Secondary Energy per carrier -->


```{r, echo = FALSE, results='asis', fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}
if(type=="NPIhist"){
  
  out = "---\n\n";
  out = paste0(out,"## NPI hist per carrier\n\n");
  out = paste0(out,"### NPI Historical Secondary Energy per carrier\n\n");
  
  cat(out)
  
  print(g$`NPI Historical Secondary Energy per carrier`)
}
```


---

## Trade

### Secondary Energy Trade

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Trade Secondary Energy`

```

---

## Electricity

### Secondary Energy Electricity

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Secondary Energy Electricity`

```


<!-- --- -->

<!-- ## NPI hist Electricity -->

<!-- ### NPI Historical Secondary Energy Electricity -->


```{r, echo = FALSE, results='asis', fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}
if(type=="NPIhist"){
  
  out = "---\n\n";
  out = paste0(out,"## NPI hist Electricity\n\n");
  out = paste0(out,"### NPI Historical Secondary Energy Electricity\n\n");
  
  cat(out)
  
  print(g$`NPI Historical Secondary Energy Electricity`)
}
```



---

# Secondary Energy Prices {.tabset}

## Secondary Energy Prices

### Secondary Energy Prices per carrier

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Secondary Energy Price per carrier`

```

---

## per model

### Secondary Energy Prices per model

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Secondary Energy Price per model`

```

---

# Final Energy {.tabset}

## Final Energy

### Final Energy

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Final Energy`

```

---

## per carrier

### Final Energy per carrier

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Final Energy per carrier`

```


<!-- --- -->

<!-- ## NPI hist per carrier -->

<!-- ### NPI Historical Final Energy per carrier -->


```{r, echo = FALSE, results='asis', fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}
if(type=="NPIhist"){
  
  out = "---\n\n";
  out = paste0(out,"## NPI hist per carrier\n\n");
  out = paste0(out,"### NPI Historical Final Energy per carrier\n\n");
  
  cat(out)
  
  print(g$`NPI Historical Final Energy per carrier`)
}
```


---

## per sector

### Final Energy per sector

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Final Energy per sector`

```


<!-- --- -->

<!-- ## NPI hist per sector -->

<!-- ### NPI Historical Final Energy per sector -->


```{r, echo = FALSE, results='asis', fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}
if(type=="NPIhist"){
  
  out = "---\n\n";
  out = paste0(out,"## NPI hist per sector\n\n");
  out = paste0(out,"### NPI Historical Final Energy per sector\n\n");
  
  cat(out)
  
  print(g$`NPI Historical Final Energy per sector`)
}
```



---

## Non-Energy and Industry

### Non-Energy and Industry Final Energy per carrier

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Non-Energy and Industry Final Energy per carrier`

```

---

## Buildings

### Residential and Commercial Final Energy per carrier

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Residential and Commercial Final Energy per carrier`

```

---

## Transport

### Transportation and Bunkers Final Energy per carrier

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Transportation and Bunkers Final Energy per carrier`

```

<!-- --- -->

<!-- ## Other Sectors -->

<!-- ### Other Sectors Final Energy per carrier -->

<!-- ```{r, echo = FALSE, fig.width=16, fig.height=8} -->

<!-- g$`Other Sectors Final Energy per carrier` -->

<!-- ``` -->


---

## Transport per type

### Transportation Final Energy per type

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Transportation Final Energy per type`

```

---

## Liquids per source

### Final Energy Liquids per source

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Final Energy liquids per source`

```

---

## Gases per source

### Final Energy Gases per source

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Final Energy gases per source`

```

---

## Solids per source

### Final Energy Solids per source

```{r, echo = FALSE, fig.width=chunk$nrow3$width, fig.height=chunk$nrow3$height}

g$`Final Energy solids per source`

```



---

# Final Energy Prices {.tabset}

## Industry

### Industry Final Energy Prices per carrier

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Industry Final Energy Price per carrier`

```

---

## per model

### Industry Final Energy Prices per model

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Industry Final Energy Price per model`

```

---

## Residential and Commercial

### Residential and Commercial Final Energy Prices per carrier

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Residential and Commercial Final Energy Price per carrier`

```

---

## per model

### Residential and Commercial Final Energy Prices per model

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Residential and Commercial Final Energy Price per model`

```

---

## Transportation

### Transportation Final Energy Prices per carrier

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Transportation Final Energy Price per carrier`

```


---

## per model

### Transportation Final Energy Prices per model

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Transportation Final Energy Price per model`

```


---

# Economy {.tabset}

## Population

### Population

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`Population`

```

---

## GDP MER

### GDP MER

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`GDP MER`

```

---

## GDP PPP

### GDP PPP

```{r, echo = FALSE, fig.width=chunk$nrow2$width, fig.height=chunk$nrow2$height}

g$`GDP PPP`

```

---



<!-- modal code -->
<script type="text/javascript">

$(document).ready(function () {

$("img").attr("title", "click to see in fullscreen")
  
$("body").append(
'<!-- The Modal -->\
<div id="myModal" class="modal hide">\
  <!-- Modal content -->\
  <div class="modal-content">\
    <span class="close">&times;</span>\
    <div class="modal-card">\
      <img class="modal-img"\
        alt="">\
    </div>\
  </div>\
</div>').ready(function(){

  $("img").click(function(){
    src = $(this).attr("src");
    $(".modal-img").attr("src", src);
    $(".modal").removeClass("hide").addClass("block");              
  });

  $(".modal .close").click(function () {
      console.log(this);
    $(".modal").removeClass("block").addClass("hide");
  });

  $(window).click(function (event) {
    if (event.target == myModal) {
      $(".modal").removeClass("block").addClass("hide");
    }
  });

  });
});

</script>




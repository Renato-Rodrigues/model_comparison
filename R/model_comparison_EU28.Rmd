
---
title: "ECEMF model comparison plots for EU27 & UK"
output:
  html_document:
    theme: paper
    toc: true
    toc_float:
      collapsed: false
---

<!-- author: "Renato Rodrigues" -->

<style>
  .main-container {
    max-width: 95% !important;
  }
  .toc-content {
    padding-left: 0px !important;
  }
  .svg-container {
    margin: auto !important;
  }
</style>

Description:
Model comparison for ECEMF - Summary plots.

Regions represented in the plots:

* EU27 & UK: "REMIND 2.1", "WITCH 5.0", "OSeMBE v1.0.0" (calculated) and "Euro-Calliope 2.0" (calculated) 
* Europe: "IMAGE 3.2", "PROMETHEUS 1.2", "MEESA v1.1"   
* Europe (excl. Turkey): "TIAM-ECN 1.2"
* "MESSAGEix-GLOBIOM_1.2" only reported the region "World" so far.
* "PRIMES" is missing results in the database


<!-- Options -->
```{r options, include=FALSE}

# if you want to download new results set updateResults to TRUE, else the script will load the latest created csv file in the folder ./data
updateResults = TRUE

```


<!-- Loading required packages -->
```{r Loading_required_packages, echo=FALSE, include=FALSE}
library(reticulate)
library(rjson)
library(ggplot2)
library(dplyr)
library(tidyr)
library(gridExtra)
library(grid)
library(svglite)
library(gtable)
```


```{r download_data, include=FALSE}
if(updateResults){
  if (file.exists("credentials.json")){
    credentials <- fromJSON(file="credentials.json")
  } else {
    stop('To download the most up to date ECEMF data, please rename the file "credentials_example.json" to "credentials.json" and fill it with your iiasa database credentials.')
  }
}

#create data folder
if(!(file.exists("./data")))
   dir.create("./data")

```


```{python, include=FALSE}

if (r.updateResults):
  
  import pyam
  pyam.iiasa.set_config(r.credentials["login"], r.credentials["password"])
  conn = pyam.iiasa.Connection()
  conn.connect('ecemf_internal')

  df = conn.query(
      model='*',
      variable='*',
      region='*'
  )
  
  from datetime import datetime
  now = datetime.now()
  filename = "data_" + now.strftime("%Y_%m_%d_%H.%M.%S")
  
  df.to_excel("./data/" + filename + ".xlsx")
  
  import pandas as pd

  read_file = pd.read_excel("./data/" + filename + ".xlsx", sheet_name="data")
  read_file.to_csv("./data/" + filename + ".csv", index = None, header=True)

```


```{r load_data, include=FALSE}

  files <- file.info(list.files(path="./data", pattern="^data_.*.csv", full.names = T))

  if (!(nrow(files))){
    stop('You need a valid csv file in the ./data folder with model data. You can set the option updateResults to TRUE to download the data directly from the iiasa database. Just set your credentials to the database also in the "credentials.json" file.')
  }
  filename <- rownames(files)[which.max(files$mtime)]
  
  dateString <- gsub("./data/data_|.csv", "", filename)
  
  df <- read.csv(filename,check.names=FALSE,stringsAsFactors=FALSE, dec = ".")

```


<!-- Loading Data -->
```{r preparing_data, echo=FALSE, include=FALSE}

#remove unwanted models
df <- df[!df$Model %in% c("OSeMBE v0.1.2", "test_model"),]

#rename scenarios
scenRename <- c(
  "DIAG_C0to80-gr5" = "DIAG-C0to80-gr5",
  "DIAG_C400-lin" = "DIAG-C400-lin",
  "DIAG_C80-gr5" = "DIAG-C80-gr5" ,
  "DIAG_NPi" = "DIAG-NPI",
  "DIAG_Nzero" = "DIAG-NZero",
  "DIAG-Nzero" = "DIAG-NZero"
)
df[df$Scenario %in% names(scenRename),]$Scenario <- scenRename[df[df$Scenario %in% names(scenRename),]$Scenario]

# select scenarios
df <- df[df$Scenario %in% c("DIAG-Base", "DIAG-NPI", "DIAG-C80-gr5", "DIAG-C0to80-gr5", "DIAG-C400-lin", "DIAG-NZero"),]

#reorder scenarios
df <- df %>%
  mutate(Scenario = factor(Scenario, levels=c("DIAG-Base", "DIAG-NPI", "DIAG-C80-gr5", "DIAG-C0to80-gr5", "DIAG-C400-lin", "DIAG-NZero")))

#long format
dfLong <- df %>%
  gather(period, value, -c(1:5)) 

# removing Na values
dfLong <- dfLong[!is.na(dfLong$value),]

#Create Region aggregate for "OSeMBE v1.0.0" and "Euro-Calliope 2.0"
`EU27 & UK` <- c("Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark",
          "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy",
          "Latvia", "Lithuania", "Luxembourg", "Malta", "The Netherlands", "Poland", "Portugal",
          "Romania", "Slovakia", "Slovenia", "Spain", "Sweden",
          "United Kingdom"
          )

tmp <- dfLong[(dfLong$Model == "Euro-Calliope 2.0" & dfLong$Region %in% `EU27 & UK`),]
tmp <- tmp[-(tmp$Unit %in% c("US$2010/kW/yr","billion US$2010/yr","EUR/MWh")) ,]
tmp <- tmp %>% group_by(Model,Scenario,Variable, Unit, period) %>%
  summarize(value = sum(value))
tmp$Region <- "EU27 & UK"
tmp <- as.data.frame(tmp[,c(1,2,7,3,4,5,6)])

dfLong <- rbind(dfLong,tmp)

#unique(dfLong[dfLong$Region == "EU27 & UK",]$Model)

tmp <- dfLong[(dfLong$Model == "OSeMBE v1.0.0" & dfLong$Region %in% `EU27 & UK`),]
tmp <- tmp %>% group_by(Model,Scenario,Variable, Unit, period) %>%
  summarize(value = sum(value))
tmp$Region <- "EU27 & UK"
tmp <- as.data.frame(tmp[,c(1,2,7,3,4,5,6)])

dfLong <- rbind(dfLong,tmp)

#select Regions
dfLong <- dfLong[dfLong$Region %in% c("EU27 & UK", "Europe", "Europe (excl. Turkey)"),] #"EU27", 

# changing period to numeric
dfLong$period <- as.numeric(dfLong$period)

#remove version from model names
dfLong$Model <- gsub("v\\d*\\.?\\d*\\.?\\d*", "", dfLong$Model) # remove "v1.0.0"
dfLong$Model <- gsub("v\\d*\\.?\\d*", "", dfLong$Model) # remove "v1.1"
dfLong$Model <- gsub(" \\d*\\.?\\d*", "", dfLong$Model) # remove "1.1"
dfLong$Model <- gsub("\\s$*", "", dfLong$Model) # remove trailing spaces
dfLong$Model <- gsub("\\_*$", "", dfLong$Model) # remove trailing underscores

#rename MESSAGE
dfLong[df$Model == "MESSAGEix-GLOBIOM",] <- "MESSAGE"

#oder of Models
dfLong$Model <- factor(dfLong$Model, levels = c("IMAGE","Euro-Calliope","MEESA","MESSAGE","OSeMBE","PRIMES","PROMETHEUS","REMIND","TIAM-ECN","WITCH"))

#report number of vars per model
nVars <- NULL
for (model in unique(df$Model)){
  n <- length(unique(df[df$Model == model,]$Variable))
  names(n) = model
  nVars <- c(nVars, n)
} 

```


<!-- Aesthetics -->
```{r aestetics, echo=FALSE, include=FALSE}

#knitr::opts_chunk$set(echo = TRUE)
# setting global R chunk options (https://yihui.name/knitr/options/#chunk_options)
  knitr::opts_chunk$set(dev='svglite', # svg, png,...
                        fig.ext = ".svg",
                        #fig.asp = .8 # default aspect ratio
                        fig.width = 16,
                        fig.height = 9,
                        dpi=100
                        )

color <- c(
#model
  "IMAGE" = "#000000",
  "Euro-Calliope" = "#c0c0c0",
  "MEESA" = "#ff00ff",
  "MESSAGE" = "#800080",
  "OSeMBE" = "#a52a2a",
  "PRIMES" = "#0000ff",
  "PROMETHEUS" = "#ffd900",
  "REMIND" = "#ff6347",
  "TIAM-ECN" = "#4682b4",
  "WITCH" = "#228b22",
#scenario
  "DIAG-Base" = "#f1746e",
  "DIAG-NPI" = "#b49f06",
  "DIAG-C80-gr5" = "#2eba38",
  "DIAG-C0to80-gr5" = "#38c0c4",
  "DIAG-C400-lin" = "#939dff",
  "DIAG-NZero" = "#f062e4",
#emi
  "Supply" = "#3D4849",
  "Supply - Electricity"= "#ffb200",
  "Supply - Heat"= "#cc0000",
  "Supply - Gases"= "#999959",
  "Supply - Liquids"= "#0000cc",
  "Supply - Solids"= "#0c0c0c",
  "Supply - Other" = "#79a6d2",
  "Demand" = "#999959",
  "Demand - Transportation" = "#a1dd70",
  "Demand - Residential and Commercial" = "#5edfff",
  "Demand - Other Sector" = "#999959",
  "Demand - AFOFI" = "#005900",
  "Demand - Industry" = "#5f6769",
  "Industrial Processes" = "#b2b2b2",
  "Other" = "#5b0d8f",
  "AFOLU" = "#4DAF4A",
#capture
  "CCS - Biomass" = "#008c00",
  "CCS - Biomass Energy" = "#005900",
  "CCS - Biomass Industry" = "#377EB8",
  "CCS - Biomass Industrial Processes" = "#79a6d2",
  "CCS - Fossil" = "#cccccc",
  "CCS - Fossil Energy" = "#a6a6a6",
  "CCS - Fossil Industry" = "#4e4e4e",
  "CCS - Fossil Industrial Processes" = "#282828",
  "DAC" = "#CC6666",
  "Enhanced Weathering" = "#5b0d8f",
  "Land Use Capture" = "#4DAF4A",
#carrier
  "Electricity" = "#ffb200",
  "Heat"        = "#cc0000",
  "Hydrogen"    = "#5ed5b0",
  "Gases"       = "#999959",
  "Gases - Fossil"  = "#a1a161", # #a1a161",
  "Gases - Biomass" = "#999959", # "#999959",
  "Gases - Efuel"   = "#caca8a", # "#caca8a",
  "Liquids"     = "#0000cc",
  "Liquids - Fossil"  = "#000068", #"#000068",
  "Liquids - Biomass" = "#0000cc", #"#0000cc",
  "Liquids - Efuel"   = "#5050ff", #"#5050ff",
  "Solids"      = "#0c0c0c",
  "Solids - Fossil"  = "#0c0c0c", 
  "Solids - Biomass" = "#9fa1a4", 
  "Other Carrier" = "#79a6d2",
  "Geothermal" = "#e51900",
  "Solar" = "#ffcc00",
  "Non-Energy Biomass" = "#005900",
  "Non-Energy Coal" = "#b2b2b2",
  "Non-Energy Gas" = "#b79e38",
  "Non-Energy Oil" = "#ff6565",
#sector
  "Industry" = "#5f6769",
  "Residential and Commercial" = "#5edfff",
  "Transportation" = "#a1dd70",
  "Non-Energy Use" = "#ff9966",
#tech
  "Solar" = "#ffcc00",
  "Solar CSP" = "#ffcc00",
  "Solar PV" = "#ffe600",
  "Wind" = "#337fff",
  "Wind Offshore" = "#4d33ff",
  "Wind Onshore" = "#337fff",
  "Other" = "#5b0d8f",
  "Ocean" = "#0000FF",
  "Biomass" = "#005900",
  "Biomass w/ CCS" = "#33ff00",
  "Biomass w/o CCS" = "#005900",
  "Hydro" = "#191999",
  "Hydro Reservoir" = "#8a8aec",
  "Hydro Pumped Storage" = "#dfdffa",
  "Hydro Run of River" = "#191999",
  "Geothermal" = "#e51900",
  "Nuclear" = "#ff33ff",
  "Gas" = "#999959",
  "Gas CCGT" = "#7c6b2a",
  "Gas w/ CCS" = "#b79e38",
  "Gas w/o CCS" = "#999959",
  "Coal" = "#0c0c0c",
  "Coal w/ CCS" = "#b2b2b2",
  "Coal w/o CCS" = "#0c0c0c",
  "Oil" = "#b30000",
  "Oil w/ CCS" = "#ff6565",
  "Oil w/o CCS" = "#b30000"
)

hierarchy <- list(
  # Emi
  "Supply" = c(
    "Supply - Electricity",  
    "Supply - Heat",
    "Supply - Gases",
    "Supply - Liquids",
    "Supply - Solids",
    "Supply - Other"
    ),
  "Demand" = c(
    "Demand - Transportation",
    "Demand - Residential and Commercial",
    "Demand - Other Sector",
    "Demand - AFOFI",
    "Demand - Industry"
    ),
  "Industrial Processes" = c("Industrial Processes"),
  "Other" = c("Other"),
  "AFOLU" = c("AFOLU"),
  #Capture
  "CCS - Biomass" = c(
    "CCS - Biomass Energy",
    "CCS - Biomass Industry",
    "CCS - Biomass Industrial Processes"
    ),
  "CCS - Fossil" = c(
    "CCS - Fossil Energy",
    "CCS - Fossil Industry",
    "CCS - Fossil Industrial Processes"
  ),
  "DAC" = c("DAC"),
  "Enhanced Weathering" = c("Enhanced Weathering"),
  "Land Use Capture" = c("Land Use Capture"),
  # SE
  "Electricity" = c("Electricity"),
  "Heat" = c("Heat"),
  "Hydrogen" = c("Hydrogen"),
  "Gases" = c(
    "Gases - Fossil",
    "Gases - Biomass",
    "Gases - Efuel"
    ),
  "Liquids" = c(
    "Liquids - Fossil",
    "Liquids - Biomass",
    "Liquids - Efuel"
  ),
  "Solids" = c(
    "Solids - Fossil",
    "Solids - Biomass"
  ),
  "Other Carrier" = c("Other Carrier"),
  # PE
  "Solar" = c(
    "Solar CSP",
    "Solar PV"
  ),
  "Wind" = c(
    "Wind Offshore",
    "Wind Onshore"
    ), 
  "Ocean" = c("Ocean"),
  "Other" = c("Other"),
  "Biomass" = c(
    "Biomass w/ CCS",
    "Biomass w/o CCS"
    ),
  "Hydro" = c(
    "Hydro Reservoir",
    "Hydro Pumped Storage",
    "Hydro Run of River"
  ),
  "Geothermal" = c("Geothermal"),
  "Nuclear" = c("Nuclear"),
  "Gas" = c(
    "Gas w/ CCS",
    "Gas w/o CCS"
    ),
  "Coal" = c(
    "Coal w/ CCS",
    "Coal w/o CCS"
    ),
  "Oil" = c(
    "Oil w/ CCS",
    "Oil w/o CCS"
  )
)

#plot aesthetics
theme_singleColumn <- function(){
  theme_minimal(base_size = 16) +
  theme(
    axis.title.x = element_blank(),
    axis.text.x = element_text(angle=90, hjust = 1, vjust = 0.5),
    legend.position="bottom",
    legend.title=element_blank(),
    legend.key.size = unit(20,"pt"),
    legend.text = element_text(size=14, margin = margin(r = 20, unit = 'pt')),
    panel.spacing = unit(1.5, "lines")
  )
}

#function to space facets
spaceFacet <- function(gg,size=3,layout=c(15,27)){
  gt = ggplot_gtable(ggplot_build(gg))
  #gtable_show_layout(gt)
  for (item in layout){
    gt$widths[item] = size*gt$widths[item]
  }
  return(gt) 
}


```

<!-- Creating Plots -->
```{r initialize_plots_object, echo=FALSE, include=FALSE}
g <- NULL

# function to create bar Plots
barPlot <- function(data,total=NULL,title="", legend = list(nRow=NULL)){
  gg <- ggplot(data,aes(x=Model,y=value,fill=Variable)) +
    geom_hline(yintercept=0, color = "black", size=1, alpha = 0.15) +
    geom_point(data=total,aes(x=Model,y=value,fill="gray"), shape=23, alpha = 0.5) +
    geom_bar(stat='identity') +
    facet_wrap(~Scenario+period, scales='free_x', nrow=2, labeller = labeller(Scenario = function(Variable, value) {c("", "DIAG-Base","","","DIAG-NPI","","","DIAG-C80-gr5","","", "DIAG-C0to80-gr5","","","DIAG-C400-lin","","","DIAG-NZero","")})) +
    theme_singleColumn() + 
    scale_fill_manual(values = setNames(color[names(vars)],vars), labels = setNames(names(vars),vars)) +

    scale_x_discrete(drop=FALSE) +
    ylab(title) +
    theme(axis.text.x = element_text(size = 10))
  if(!is.null(legend$nRow))
    gg <- gg + guides(fill = guide_legend(nrow = legend$nRow))
  return(gg)
}

# function to create line Plots
linePlot <- function(data,title="", colorDim="Model", facetDim="Scenario"){
  gg <- ggplot(data,aes_(x=~period,y=~value,color=as.formula(paste0("~",colorDim)),group=as.formula(paste0("~",colorDim)))) + 
    geom_hline(yintercept=0, color = "black", size=1, alpha = 0.15) +
    geom_vline(xintercept=2020, color = "black", size=1, alpha = 0.15, linetype = "dashed") +
    geom_line(size=1) + #,linetype=parent
    geom_point() +
    facet_wrap(facetDim) +
    theme_singleColumn() +
    theme(
      legend.key.size = unit(30,"pt"),
      legend.text = element_text(size=16, margin = margin(r = 20, t = 10, b = 10, unit = 'pt'))
    ) +
    scale_color_manual(values = setNames(color[levels(d[[colorDim]])],levels(d[[colorDim]])),drop=FALSE) + 
    ylab(title) +
    scale_x_continuous(breaks=seq(2010, 2050, 10))
  return(gg)
}

```



# CO2 emissions

```{r, echo = FALSE, include=FALSE}

vars <- c("Emissions|CO2")

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period <= 2050),] 

g$emiCO2 <- linePlot(data=d,title="CO2 Emissions (Mt CO2/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=8}

g$emiCO2

```

## CO2 emissions per source

```{r, echo = FALSE, include=FALSE}

vars <- c(
  "Supply" = "Emissions|CO2|Energy|Supply",
  "Supply - Electricity" = "Emissions|CO2|Energy|Supply|Electricity",  
	"Supply - Heat" = "Emissions|CO2|Energy|Supply|Heat",
	"Supply - Gases" = "Emissions|CO2|Energy|Supply|Gases",
	"Supply - Liquids" = "Emissions|CO2|Energy|Supply|Liquids",
	"Supply - Solids" = "Emissions|CO2|Energy|Supply|Solids",
  "Supply - Other" = "Emissions|CO2|Energy|Supply|Other Sector",
	"Demand" = "Emissions|CO2|Energy|Demand",
  "Demand - Transportation" = "Emissions|CO2|Energy|Demand|Transportation",
	"Demand - Residential and Commercial" = "Emissions|CO2|Energy|Demand|Residential and Commercial",
	"Demand - Other Sector" = "Emissions|CO2|Energy|Demand|Other Sector",
	"Demand - AFOFI" = "Emissions|CO2|Energy|Demand|AFOFI",
	"Demand - Industry" = "Emissions|CO2|Energy|Demand|Industry",
	"Industrial Processes" = "Emissions|CO2|Industrial Processes",
  "Other" = "Emissions|CO2|Other",
  "AFOLU" = "Emissions|CO2|AFOLU"
)

tmp <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),]

d <- NULL
for (model in unique(tmp$Model)){
  curr <- tmp[tmp$Model == model,]
  for (tech in names(hierarchy)){
    if(nrow(curr[curr$Variable %in% vars[hierarchy[[tech]]],])){
      d <- rbind(d, curr[curr$Variable %in% vars[hierarchy[[tech]]],])
    } else {
      d <- rbind(d, curr[curr$Variable %in% vars[tech],])
    }
  }
}

#order
d$Variable <- factor(d$Variable , levels = vars) 

#total emi
d2 <- dfLong[(dfLong$Variable %in% c("Emissions|CO2") & dfLong$period %in% c(2020,2030,2050)),]

#creating plot
g$emiSource <- barPlot(data=d,total=d2,title="CO2 emissions per source (Mt CO2/yr)") 

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$emiSource))

```

---

# Carbon Price

```{r, echo = FALSE, include=FALSE}

vars <- c("Price|Carbon")

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period <= 2100),] 

g$carbonPrice <- linePlot(data=d,title="Carbon Price (\u20ac/t CO2)")

g$carbonPrice2 <- linePlot(data=d,title="Carbon Price (\u20ac/t CO2)", colorDim="Scenario", facetDim="Model")

```


## per scenario

```{r, echo = FALSE, fig.width=16, fig.height=8}

g$carbonPrice

```

## per model

```{r, echo = FALSE, fig.width=16, fig.height=8}

g$carbonPrice2

```


---

# Carbon Capture and Storage (CCS)

```{r, echo = FALSE, include=FALSE}

vars <- c("Carbon Sequestration|CCS")

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period <= 2050),] 

g$ccs <- linePlot(data=d,title="Carbon Capture and Storage (Mt CO2/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=8}

g$ccs

```




## Carbon Sequestration per source


```{r, echo = FALSE, include=FALSE}

vars <- c(
  "CCS - Biomass" = "Carbon Sequestration|CCS|Biomass|Energy",
  "CCS - Biomass Energy" = "Carbon Sequestration|CCS|Biomass|Energy|Supply",
  "CCS - Biomass Industry" = "Carbon Sequestration|CCS|Biomass|Energy|Demand|Industry",
  "CCS - Biomass Industrial Processes" = "Carbon Sequestration|CCS|Biomass|Industrial Processes",
  "CCS - Fossil" = "Carbon Sequestration|CCS|Fossil",
  "CCS - Fossil Energy" = "Carbon Sequestration|CCS|Fossil|Energy|Supply",
	"CCS - Fossil Industry" = "Carbon Sequestration|CCS|Fossil|Energy|Demand|Industry",
	"CCS - Fossil Industrial Processes" = "Carbon Sequestration|CCS|Fossil|Industrial Processes",
  "DAC" = "Carbon Sequestration|Direct Air Capture",
  "Enhanced Weathering" = "Carbon Sequestration|Enhanced Weathering",
  "Land Use Capture" = "Carbon Sequestration|Land Use"
)

tmp <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),]

d <- NULL
for (model in unique(tmp$Model)){
  curr <- tmp[tmp$Model == model,]
  for (tech in names(hierarchy)){
    if(nrow(curr[curr$Variable %in% vars[hierarchy[[tech]]],])){
      d <- rbind(d, curr[curr$Variable %in% vars[hierarchy[[tech]]],])
    } else {
      d <- rbind(d, curr[curr$Variable %in% vars[tech],])
    }
  }
}

#order
d$Variable <- factor(d$Variable , levels = vars) 

#total capture
d2 <- dfLong[(dfLong$Variable %in% c("Carbon Sequestration|CCS","Carbon Sequestration|Direct Air Capture","Carbon Sequestration|Enhanced Weathering","Carbon Sequestration|Land Use") & dfLong$period %in% c(2020,2030,2050)),] %>%
  group_by(Model,Scenario,Region,period) %>% 
  summarize(value = sum(value))

#creating plot
g$capture <- barPlot(data=d,total=d2,title="Carbon Sequestration per source (Mt CO2/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$capture))

```

---

# Primary Energy

```{r, echo = FALSE, include=FALSE}

vars <- c("Primary Energy")

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period <= 2050),]

g$pe <- linePlot(data=d,title="Primary Energy (EJ/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=8}

g$pe

```

## Primary Energy per Carrier

```{r, echo = FALSE, include=FALSE}

vars <- c(
  "Solar" = "Primary Energy|Solar",
  "Wind" = "Primary Energy|Wind",
  "Ocean" = "Primary Energy|Ocean",
  "Other" = "Primary Energy|Other",
  "Biomass"  = "Primary Energy|Biomass",
  "Hydro" = "Primary Energy|Hydro",
  "Geothermal" = "Primary Energy|Geothermal",
  "Nuclear" = "Primary Energy|Nuclear",
  "Gas" = "Primary Energy|Gas",
  "Gas w/ CCS" = "Primary Energy|Gas|w/ CCS",
  "Gas w/o CCS" = "Primary Energy|Gas|w/o CCS",
  "Coal" = "Primary Energy|Coal",
  "Coal w/ CCS" = "Primary Energy|Coal|w/ CCS",
  "Coal w/o CCS" = "Primary Energy|Coal|w/o CCS",
  "Oil" = "Primary Energy|Oil",
  "Oil w/ CCS" = "Primary Energy|Oil|w/ CCS",
  "Oil w/o CCS" = "Primary Energy|Oil|w/o CCS"
)

tmp <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),]

d <- NULL
for (model in unique(tmp$Model)){
  curr <- tmp[tmp$Model == model,]
  for (tech in names(hierarchy)){
    if(nrow(curr[curr$Variable %in% vars[hierarchy[[tech]]],])){
      d <- rbind(d, curr[curr$Variable %in% vars[hierarchy[[tech]]],])
    } else {
      d <- rbind(d, curr[curr$Variable %in% vars[tech],])
    }
  }
}

#order
d$Variable <- factor(d$Variable , levels = vars) 

#total pe
d2 <- dfLong[(dfLong$Variable %in% c("Primary Energy") & dfLong$period %in% c(2020,2030,2050)),]

#creating plot
g$peCarrier <- barPlot(data=d,total=d2,title="Primary Energy per Carrier (EJ/yr)",legend = list(nRow=2))

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$peCarrier))

```

---

# Final Energy

```{r, echo = FALSE, include=FALSE}

vars <- c("Final Energy")

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period <= 2050),]

g$fe <- linePlot(data=d,title="Final Energy (EJ/yr)")


```

```{r, echo = FALSE, fig.width=16, fig.height=8}

g$fe

```


## Final Energy Electricity

```{r, echo = FALSE, include=FALSE}

vars <- c("Final Energy|Electricity")

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period <= 2050),]

g$feElec <- linePlot(data=d,title="Electricity Final Energy (EJ/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=8}

g$feElec

```


## Final Energy per Carrier

```{r, echo = FALSE, include=FALSE}

vars <- c(
  "Electricity" = "Final Energy|Electricity",
  "Heat" = "Final Energy|Heat",
  "Hydrogen" = "Final Energy|Hydrogen",
  "Gases" = "Final Energy|Gases",
  "Liquids" = "Final Energy|Liquids",
  "Solids" = "Final Energy|Solids",
  "Solids - Biomass" = "Final Energy|Solids|Biomass",
  "Solids - Fossil" = "Final Energy|Solids|Coal",
  "Geothermal" = "Final Energy|Geothermal",
  "Solar" = "Final Energy|Solar"
)

tmp <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),]

d <- NULL
for (model in unique(tmp$Model)){
  curr <- tmp[tmp$Model == model,]
  for (tech in names(hierarchy)){
    if(nrow(curr[curr$Variable %in% vars[hierarchy[[tech]]],])){
      d <- rbind(d, curr[curr$Variable %in% vars[hierarchy[[tech]]],])
    } else {
      d <- rbind(d, curr[curr$Variable %in% vars[tech],])
    }
  }
}

#order
d$Variable <- factor(d$Variable , levels = vars) 

#total fe
d2 <- dfLong[(dfLong$Variable %in% c("Final Energy") & dfLong$period %in% c(2020,2030,2050)),]

#creating plot
g$feCarrier <- barPlot(data=d,total=d2,title="Final Energy per Carrier (EJ/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$feCarrier))

```


---

## Final Energy per sector


```{r, echo = FALSE, include=FALSE}

vars <- c(
  "Non-Energy Use" = "Final Energy|Non-Energy Use",
  "Industry" = "Final Energy|Industry",
  "Residential and Commercial" = "Final Energy|Residential and Commercial",
  "Transportation" = "Final Energy|Transportation"
)

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),]

#order
d$Variable <- factor(d$Variable , levels = vars) 

#total fe
d2 <- dfLong[(dfLong$Variable %in% c("Final Energy") & dfLong$period %in% c(2020,2030,2050)),]

#creating plot
g$feSector <- barPlot(data=d,total=d2,title="Final Energy per Sector (EJ/yr)")

```


```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$feSector))

```

---

## Industry FE and Non-energy Use


```{r, echo = FALSE, include=FALSE}

# Industry Final Energy
vars <- c(
  "Electricity" = "Final Energy|Industry|Electricity",
  "Heat"        = "Final Energy|Industry|Heat",
  "Hydrogen"    = "Final Energy|Industry|Hydrogen",
  "Non-Energy Biomass" = "Final Energy|Non-Energy Use|Biomass",
  "Non-Energy Gas" = "Final Energy|Non-Energy Use|Gas",
  "Gases"       = "Final Energy|Industry|Gases",
  "Non-Energy Oil" = "Final Energy|Non-Energy Use|Oil",
  "Liquids"     = "Final Energy|Industry|Liquids",
  "Non-Energy Coal" = "Final Energy|Non-Energy Use|Coal",
  "Solids"      = "Final Energy|Industry|Solids",
  "Other Carrier" = "Final Energy|Industry|Other"
)

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),]

#order
d$Variable <- factor(d$Variable , levels = vars) 

#total fe industry and non-energy use
d2 <- dfLong[(dfLong$Variable %in% c("Final Energy|Industry","Final Energy|Non-Energy Use") & dfLong$period %in% c(2020,2030,2050)),] %>%
  group_by(Model,Scenario,Region,period) %>% 
  summarize(value = sum(value))

#creating plot
g$feIndst <- barPlot(data=d,total=d2,title="Industry FE and Non-energy Use (EJ/yr)",legend = list(nRow=2))

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$feIndst))

```

## Residential and Commercial Final Energy

```{r, echo = FALSE, include=FALSE}

vars <- c(
  "Electricity" = "Final Energy|Residential and Commercial|Electricity",
  "Heat"        = "Final Energy|Residential and Commercial|Heat",
  "Hydrogen"    = "Final Energy|Residential and Commercial|Hydrogen",
  "Gases"       = "Final Energy|Residential and Commercial|Gases",
  "Liquids"     = "Final Energy|Residential and Commercial|Liquids",
  "Solids"      = "Final Energy|Residential and Commercial|Solids",
  "Other Carrier" = "Final Energy|Residential and Commercial|Other"
)

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),]

#order
d$Variable <- factor(d$Variable , levels = vars) 

#total fe Residential and Commercial
d2 <- dfLong[(dfLong$Variable %in% c("Final Energy|Residential and Commercial") & dfLong$period %in% c(2020,2030,2050)),] 
#creating plot
g$feBuild <- barPlot(data=d,total=d2,title="Residential and Commercial FE (EJ/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$feBuild))

```

## Transportation Final Energy

```{r, echo = FALSE, include=FALSE}

vars <- c(
  "Electricity" = "Final Energy|Transportation|Electricity",
  "Hydrogen"    = "Final Energy|Transportation|Hydrogen",
  "Gases"       = "Final Energy|Transportation|Gases",
  "Liquids"     = "Final Energy|Transportation|Liquids",
  "Other Carrier" = "Final Energy|Transportation|Other"
)

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),]

#order
d$Variable <- factor(d$Variable , levels = vars) 

#total fe Transportation
d2 <- dfLong[(dfLong$Variable %in% c("Final Energy|Transportation") & dfLong$period %in% c(2020,2030,2050)),] 

#creating plot
g$feTrans <- barPlot(data=d,total=d2,title="Transportation Final Energy (EJ/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$feTrans))

```

---

# Electricity
```{r, echo = FALSE, include=FALSE}

vars <- c("Electricity" = "Secondary Energy|Electricity")

d <- dfLong[(dfLong$Variable %in% vars & dfLong$period <= 2050),] 

#convert from EJ to TWh
d$value <- 1/0.0036 * d$value # converting from EJ to TWh
d$Unit <- "TWh/yr"

g$elec <- linePlot(data=d,title="Secondary Energy Electricity (TWh/yr)")

```

```{r, echo = FALSE, fig.width=16, fig.height=8}

g$elec

```

## Electricity Generation


```{r, echo = FALSE, include=FALSE}

vars <- c(
  "Solar" = "Secondary Energy|Electricity|Solar",
  "Solar CSP" = "Secondary Energy|Electricity|Solar|CSP",
  "Solar PV" = "Secondary Energy|Electricity|Solar|PV",
  "Wind" = "Secondary Energy|Electricity|Wind",
  "Wind Offshore" = "Secondary Energy|Electricity|Wind|Offshore",
  "Wind Onshore" = "Secondary Energy|Electricity|Wind|Onshore",
  "Other" = "Secondary Energy|Electricity|Other",
  "Biomass" = "Secondary Energy|Electricity|Biomass",
  "Biomass w/ CCS" = "Secondary Energy|Electricity|Biomass|w/ CCS",
  "Biomass w/o CCS" = "Secondary Energy|Electricity|Biomass|w/o CCS",
  "Hydro" = "Secondary Energy|Electricity|Hydro",
  "Geothermal" = "Secondary Energy|Electricity|Geothermal",
  "Nuclear" = "Secondary Energy|Electricity|Nuclear",
  "Gas" = "Secondary Energy|Electricity|Gas",
  "Gas w/ CCS" = "Secondary Energy|Electricity|Gas|w/ CCS",
  "Gas w/o CCS" = "Secondary Energy|Electricity|Gas|w/o CCS",
  "Coal" = "Secondary Energy|Electricity|Coal",
  "Coal w/ CCS" = "Secondary Energy|Electricity|Coal|w/ CCS",
  "Coal w/o CCS" = "Secondary Energy|Electricity|Coal|w/o CCS",
  "Oil" = "Secondary Energy|Electricity|Oil",
  "Oil w/ CCS" = "Secondary Energy|Electricity|Oil|w/ CCS",
  "Oil w/o CCS" = "Secondary Energy|Electricity|Oil|w/o CCS"
)

tmp <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),] 

d <- NULL
for (model in unique(tmp$Model)){
  curr <- tmp[tmp$Model == model,]
  for (tech in names(hierarchy)){
    if(nrow(curr[curr$Variable %in% vars[hierarchy[[tech]]],])){
      d <- rbind(d, curr[curr$Variable %in% vars[hierarchy[[tech]]],])
    } else {
      d <- rbind(d, curr[curr$Variable %in% vars[tech],])
    }
  }
}
#order
d$Variable <- factor(d$Variable , levels = vars) 

#convert from EJ to TWh
d$value <- 1/0.0036 * d$value # converting from EJ to TWh
d$Unit <- "TWh/yr"

#total se electricity
d2 <- dfLong[(dfLong$Variable %in% c("Secondary Energy|Electricity") & dfLong$period %in% c(2020,2030,2050)),] 

#convert from EJ to TWh
d2$value <- 1/0.0036 * d2$value # converting from EJ to TWh
d2$Unit <- "TWh/yr"

#creating plot
g$gen <- barPlot(data=d,total=d2,title="Electricity Generation (TWh/yr)",legend = list(nRow=4))

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$gen))

```


## Electricity Capacity

```{r, echo = FALSE, include=FALSE}

vars <- c(
  "Solar" = "Capacity|Electricity|Solar",
  "Solar CSP" = "Capacity|Electricity|Solar|CSP",
  "Solar PV" = "Capacity|Electricity|Solar|PV",
  "Wind" = "Capacity|Electricity|Wind",
  "Wind Offshore" = "Capacity|Electricity|Wind|Offshore",
  "Wind Onshore" = "Capacity|Electricity|Wind|Onshore",
  "Other" = "Capacity|Electricity|Other",
  "Biomass" = "Capacity|Electricity|Biomass",
  "Biomass w/ CCS" = "Capacity|Electricity|Biomass|w/ CCS",
  "Biomass w/o CCS" = "Capacity|Electricity|Biomass|w/o CCS",
  "Hydro" = "Capacity|Electricity|Hydro",
  "Hydro Reservoir" = "Capacity|Electricity|Hydro|Reservoir",
  "Hydro Pumped Storage" = "Capacity|Electricity|Hydro|Pumped Storage",
  "Hydro Run of River" = "Capacity|Electricity|Hydro|Run of River",
  "Geothermal" = "Capacity|Electricity|Geothermal",
  "Nuclear" = "Capacity|Electricity|Nuclear",
  "Gas" = "Capacity|Electricity|Gas",
  "Gas w/ CCS" = "Capacity|Electricity|Gas|w/ CCS",
  "Gas w/o CCS" = "Capacity|Electricity|Gas|w/o CCS",
  "Coal" = "Capacity|Electricity|Coal",
  "Coal w/ CCS" = "Capacity|Electricity|Coal|w/ CCS",
  "Coal w/o CCS" = "Capacity|Electricity|Coal|w/o CCS",
  "Oil" = "Capacity|Electricity|Oil",
  "Oil w/ CCS" = "Capacity|Electricity|Oil|w/ CCS",
  "Oil w/o CCS" = "Capacity|Electricity|Oil|w/o CCS"
)


tmp <- dfLong[(dfLong$Variable %in% vars & dfLong$period %in% c(2020,2030,2050)),] 

d <- NULL
for (model in unique(tmp$Model)){
  curr <- tmp[tmp$Model == model,]
  for (tech in names(hierarchy)){
    if(nrow(curr[curr$Variable %in% vars[hierarchy[[tech]]],])){
      d <- rbind(d, curr[curr$Variable %in% vars[hierarchy[[tech]]],])
    } else {
      d <- rbind(d, curr[curr$Variable %in% vars[tech],])
    }
  }
}

#order
d$Variable <- factor(d$Variable , levels = vars) 

#creating plot
g$cap <- barPlot(data=d,title="Electricity Capacity (GW)",legend = list(nRow=4))

```

```{r, echo = FALSE, fig.width=16, fig.height=10}

grid.draw(spaceFacet(g$cap))

```


---

